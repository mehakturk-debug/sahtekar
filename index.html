<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒ∞mpostor Pro - Fixed Audio</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: var(--card); border-radius: 24px; padding: 25px; width: 95%; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .screen { display: none; }
        .active { display: block; }
        select, input { width: 100%; padding: 12px; margin: 10px 0; background: #334155; border: 1px solid #475569; color: white; border-radius: 12px; outline: none; }
        button { width: 100%; padding: 15px; background: var(--accent); color: #0f172a; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        
        /* Oyuncu Se√ßimi */
        .player-select-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .player-opt { background: #334155; padding: 10px; border-radius: 12px; text-align: center; cursor: pointer; border: 2px solid transparent; }
        .player-opt.selected { border-color: var(--accent); background: #1e293b; }
        .avatar-preview { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; margin: 0 auto 5px; background: #475569; display: block; border: 1px solid #64748b; }
        
        /* Oyun Ekranƒ± */
        #micBtn { width: 110px; height: 110px; border-radius: 50%; background: #475569; border: 6px solid #334155; color: white; font-size: 45px; margin: 20px auto; display: block; cursor: pointer; outline: none; transition: 0.3s; }
        #micBtn.recording { background: #ef4444; transform: scale(1.15); box-shadow: 0 0 40px rgba(239, 68, 68, 0.6); border-color: #fca5a5; }
        .turn-area { padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 15px; border: 2px solid rgba(255,255,255,0.1); }
        .user-photo-large { width: 90px; height: 90px; border-radius: 50%; border: 4px solid var(--accent); margin-bottom: 10px; object-fit: cover; }
        .word-display { text-align: center; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 15px; font-weight: bold; font-size: 24px; border-left: 5px solid var(--accent); }
    </style>
</head>
<body>

<div class="container">
    <div id="homeScreen" class="screen active">
        <h1 style="text-align:center; color:var(--accent); margin-top:0;">üé≠ Ekip ƒ∞mpostor</h1>
        <div class="player-select-grid" id="playerSelect">
            <div class="player-opt" data-name="Mehmet"><img src="" class="avatar-preview" id="img-Mehmet"><span>Mehmet</span></div>
            <div class="player-opt" data-name="Emre"><img src="" class="avatar-preview" id="img-Emre"><span>Emre</span></div>
            <div class="player-opt" data-name="Recep"><img src="" class="avatar-preview" id="img-Recep"><span>Recep</span></div>
            <div class="player-opt" data-name="Furkan"><img src="" class="avatar-preview" id="img-Furkan"><span>Furkan</span></div>
            <div class="player-opt" data-name="Ali"><img src="" class="avatar-preview" id="img-Ali"><span>Ali</span></div>
        </div>
        <div style="text-align:center; margin-bottom:10px;">
            <label style="font-size:13px; color:var(--accent); cursor:pointer; background:rgba(56, 189, 248, 0.1); padding:8px 15px; border-radius:20px;">
                üì∑ Fotoƒüraf Y√ºkle
                <input type="file" id="photoUpload" accept="image/*" style="display:none">
            </label>
        </div>
        <input type="text" id="room" placeholder="Oyun Kodu (Opsiyonel)">
        <button id="btnJoin">Gƒ∞Rƒ∞≈û YAP</button>
    </div>

    <div id="lobbyScreen" class="screen">
        <h2 style="text-align:center">Kod: <span id="roomDisplay" style="color:var(--accent)"></span></h2>
        <div id="playerList" style="text-align:center; margin:20px 0;"></div>
        <div id="modPanel" style="display:none; background:rgba(255,255,255,0.05); padding:15px; border-radius:15px; border:1px solid var(--accent);">
            <p style="color:var(--accent); font-weight:bold; margin:0 0 10px 0;">üîß Moderat√∂r Ayarlarƒ±</p>
            <select id="categorySelect"></select>
            <button id="btnStart" style="background:#22c55e">OYUNU BA≈ûLAT</button>
        </div>
    </div>

    <div id="gameScreen" class="screen">
        <div id="turnPanel" class="turn-area">
            <img id="activeUserPhoto" class="user-photo-large" src="">
            <h2 id="activeName" style="margin:5px 0;">Sƒ±ra Kimde?</h2>
        </div>
        <div id="wordBox" class="word-display"></div>
        <button id="micBtn">üéôÔ∏è</button>
        <p style="text-align:center; font-size:12px; color:#94a3b8; font-weight:bold;">BASILI TUTARAK KONU≈û</p>
        <button id="btnNext" style="display:none; background:#f59e0b; margin-top:20px;">SONRAKƒ∞ OYUNCU ‚ûî</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBcm1uY37IelMsTqoD0sAmsIH1nwBeYtCE",
        authDomain: "sahtekar-2f5d2.firebaseapp.com",
        databaseURL: "https://sahtekar-2f5d2-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "sahtekar-2f5d2",
        appId: "1:223883537002:web:1c16bde374d11efb5d7813"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = "", myPhoto = "", gameCode, mediaRecorder, audioChunks = [];

    // --- GENƒ∞≈û KELƒ∞ME Lƒ∞STESƒ∞ (10 Kategori x 30 Kelime) ---
    const categories = {
        "Meslekler": ["Doktor", "Pilot", "A≈ü√ßƒ±", "M√ºhendis", "Avukat", "√ñƒüretmen", "Polis", "Yazƒ±lƒ±mcƒ±", "Mimar", "Hem≈üire", "√áift√ßi", "Berber", "Kaptan", "Gazeteci", "Psikolog", "Sanat√ßƒ±", "Astronot", "Hakim", "Fƒ±rƒ±ncƒ±", "Postacƒ±", "Bah√ßƒ±van", "Terc√ºman", "Muhasebeci", "Modacƒ±", "Veteriner", "Dalgƒ±√ß", "ƒ∞tfaiyeci", "Garson", "Dedektif", "Tesisat√ßƒ±"],
        "Hayvanlar": ["Aslan", "Fil", "Z√ºrafa", "Penguen", "Kaplan", "Maymun", "Yunus", "Kartal", "Kanguru", "Timsah", "Kurt", "Ayƒ±", "Geyik", "Sincap", "Tav≈üan", "Kedi", "K√∂pek", "At", "ƒ∞nek", "Z√ºrafa", "Bukalemun", "Ahtapot", "Balina", "Yƒ±lan", "Arƒ±", "Kelebek", "Papaƒüan", "Koala", "Panda", "Su Aygƒ±rƒ±"],
        "Yemekler": ["Mantƒ±", "ƒ∞skender", "Lahmacun", "Pizza", "Hamburger", "Kuru Fasulye", "Kebap", "D√∂ner", "Su≈üi", "Makarna", "Baklava", "Pide", "B√∂rek", "Kƒ±sƒ±r", "Menemen", "√áorba", "Sarma", "Dolma", "M√ºcver", "G√∂zleme", "Salata", "Pilav", "K√∂fte", "ƒ∞√ßli K√∂fte", "Tarhana", "Humus", "K√ºnefe", "G√ºlla√ß", "S√ºtla√ß", "Lokum"],
        "≈ûehirler": ["ƒ∞stanbul", "Ankara", "ƒ∞zmir", "Londra", "Paris", "New York", "Tokyo", "Roma", "Berlin", "Moskova", "Kahire", "Madrid", "Bak√º", "Atina", "Amsterdam", "Viyana", "Prag", "Dubai", "Seul", "Pekin", "Sidney", "Venedik", "Barselona", "Lizbon", "Helsinki", "Oslo", "Stokholm", "Var≈üova", "Budape≈üte", "Tahran"],
        "E≈üyalar": ["Televizyon", "Buzdolabƒ±", "√áama≈üƒ±r Makinesi", "√út√º", "Lamba", "Saat", "Ayna", "Koltuk", "Masa", "Kitaplƒ±k", "Bilgisayar", "Telefon", "Kamera", "Radyo", "G√∂zl√ºk", "Anahtar", "C√ºzdan", "≈ûemsiye", "Bƒ±√ßak", "Ka≈üƒ±k", "√áatal", "Tabak", "Bardak", "Tencere", "Fƒ±rƒ±n", "S√ºp√ºrge", "Tarak", "Fƒ±r√ßa", "Yastƒ±k", "Battaniye"],
        "Sporlar": ["Futbol", "Basketbol", "Voleybol", "Tenis", "Y√ºzme", "G√ºre≈ü", "Ok√ßuluk", "Eskrim", "Boks", "Hentbol", "Bilardo", "Golf", "Kayak", "S√∂rf", "Satran√ß", "Bowling", "Atletizm", "Jimnastik", "Karate", "Judo", "Bisiklet", "Binicilik", "Kano", "Rafting", "Yelken", "Dart", "Masa Tenisi", "Badminton", "Daƒücƒ±lƒ±k", "Paten"],
        "Diziler/Filmler": ["Kurtlar Vadisi", "Ezel", "Avrupa Yakasƒ±", "Harry Potter", "Y√ºz√ºklerin Efendisi", "Star Wars", "Titanik", "Matrix", "√ñr√ºmcek Adam", "Batman", "Aslan Kral", "Hababam Sƒ±nƒ±fƒ±", "Gora", "Ayla", "Babam ve Oƒülum", "Vizontele", "√ái√ßek Abbas", "Tosun Pa≈üa", "S√ºt Karde≈üler", "≈ûaban Oƒülu ≈ûaban", "Ne≈üeli G√ºnler", "Selvi Boylum", "Game of Thrones", "Breaking Bad", "Sherlock", "Prison Break", "La Casa De Papel", "Stranger Things", "Dark", "Friends"],
        "Teknoloji": ["Yapay Zeka", "Robot", "ƒ∞nternet", "Mikro√ßip", "Uydu", "Drone", "Blockchain", "Metaverse", "Bluetooth", "Wi-Fi", "Lazer", "Kripto Para", "Akƒ±llƒ± Saat", "Sanal Ger√ßeklik", "Yazƒ±lƒ±m", "Donanƒ±m", "Sunucu", "Bulut Bili≈üim", "Siber G√ºvenlik", "Algoritma", "Kodlama", "Veritabanƒ±", "ƒ∞≈ülemci", "Ekran Kartƒ±", "Anakart", "Klavye", "Fare", "Kulaklƒ±k", "Hoparl√∂r", "Yazƒ±cƒ±"],
        "Meyve/Sebze": ["Elma", "Armut", "Muz", "√áilek", "Karpuz", "Kavun", "Erik", "Kiraz", "Vi≈üne", "√úz√ºm", "ƒ∞ncir", "Nar", "Portakal", "Mandalina", "Limon", "Domates", "Salatalƒ±k", "Biber", "Patlƒ±can", "Patates", "Soƒüan", "Sarƒ±msak", "Kabak", "Ispanak", "Pƒ±rasa", "Lahana", "Karnabahar", "Brokoli", "Havu√ß", "Bezelye"],
        "Hobiler": ["Fotoƒüraf", "Resim", "Gitar", "Kitap", "Kamp", "Balƒ±k Tutmak", "Dans", "Yemek", "Bah√ße ƒ∞≈üleri", "√ñrg√º", "Model U√ßak", "Pul", "Y√ºr√ºy√º≈ü", "Yoga", "Meditasyon", "Puzzle", "Oyunlar", "Seyahat", "Yazƒ±", "Heykel", "Seramik", "Origami", "Marangozluk", "Diki≈ü", "Ku≈ü G√∂zlem", "G√∂kbilim", "Tiyatro", "Sinema", "Konser", "Kayak"]
    };

    // --- FOTOƒûRAF & ƒ∞Sƒ∞M Y√úKLEME ---
    window.onload = () => {
        const catSelect = document.getElementById('categorySelect');
        Object.keys(categories).forEach(c => {
            let o = document.createElement('option'); o.value = c; o.innerText = c; catSelect.appendChild(o);
        });
        ['Mehmet', 'Emre', 'Recep', 'Furkan', 'Ali'].forEach(n => {
            const saved = localStorage.getItem('photo-' + n);
            if(saved) document.getElementById('img-' + n).src = saved;
        });
    };

    document.querySelectorAll('.player-opt').forEach(opt => {
        opt.onclick = () => {
            document.querySelectorAll('.player-opt').forEach(e => e.classList.remove('selected'));
            opt.classList.add('selected');
            myName = opt.dataset.name;
            myPhoto = localStorage.getItem('photo-' + myName) || "";
        };
    });

    document.getElementById('photoUpload').onchange = (e) => {
        if(!myName) return alert("√ñnce ismini se√ß!");
        const reader = new FileReader();
        reader.onloadend = () => {
            localStorage.setItem('photo-' + myName, reader.result);
            document.getElementById('img-' + myName).src = reader.result;
            myPhoto = reader.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    // --- HIGH QUALITY AUDIO ENGINE ---
    async function initAudio() {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true } 
        });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
            const reader = new FileReader();
            reader.readAsDataURL(new Blob(audioChunks));
            reader.onloadend = () => {
                update(ref(db, `games/${gameCode}/lastAudio`), { sender: myName, data: reader.result, time: Date.now() });
            };
            audioChunks = [];
        };
    }

    const mBtn = document.getElementById('micBtn');
    const startRec = () => { if(!mediaRecorder) initAudio().then(() => mediaRecorder.start()); else if(mediaRecorder.state === "inactive") mediaRecorder.start(); mBtn.classList.add('recording'); };
    const stopRec = () => { if(mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop(); mBtn.classList.remove('recording'); };
    mBtn.onmousedown = startRec; mBtn.onmouseup = stopRec;
    mBtn.ontouchstart = (e) => { e.preventDefault(); startRec(); }; mBtn.ontouchend = stopRec;

    // --- GAME CORE ---
    document.getElementById('btnJoin').onclick = async () => {
        if(!myName) return alert("Kim olduƒüunu se√ß!");
        let c = document.getElementById('room').value.trim().toUpperCase();
        gameCode = c || Math.random().toString(36).substring(2,6).toUpperCase();
        if(!c) await set(ref(db, `games/${gameCode}`), { status: 'waiting', moderator: myName });
        await update(ref(db, `games/${gameCode}/players/${myName}`), { name: myName, photo: myPhoto });
        document.getElementById('homeScreen').classList.remove('active');
        document.getElementById('lobbyScreen').classList.add('active');
        document.getElementById('roomDisplay').innerText = gameCode;
        listen();
    };

    function listen() {
        onValue(ref(db, `games/${gameCode}`), (s) => {
            const d = s.val(); if(!d) return;
            const players = d.players || {};
            const list = document.getElementById('playerList');
            list.innerHTML = Object.values(players).map(p => `
                <div style="display:inline-block; margin:10px; text-align:center;">
                    <img src="${p.photo}" style="width:55px; height:55px; border-radius:50%; border:2px solid #38bdf8; object-fit:cover;">
                    <p style="font-size:11px; margin:5px 0;">${p.name}</p>
                </div>`).join('');

            const isMod = myName === d.moderator;
            document.getElementById('modPanel').style.display = (isMod && d.status === 'waiting') ? 'block' : 'none';
            
            if(d.status === 'playing') {
                document.getElementById('lobbyScreen').classList.remove('active');
                document.getElementById('gameScreen').classList.add('active');
                const active = d.playerOrder[d.turn];
                const activeP = Object.values(players).find(p => p.name === active);
                document.getElementById('activeName').innerText = active;
                document.getElementById('activeUserPhoto').src = activeP?.photo || "";
                document.getElementById('wordBox').innerText = (d.impostor === myName) ? "üé≠ ƒ∞MPOSTORSUN" : "Kelime: " + d.word;
                document.getElementById('btnNext').style.display = isMod ? 'block' : 'none';
            }
        });
        onValue(ref(db, `games/${gameCode}/lastAudio`), (s) => {
            const a = s.val(); if(a && a.sender !== myName) { let snd = new Audio(a.data); snd.play(); }
        });
    }

    document.getElementById('btnStart').onclick = async () => {
        const s = await get(ref(db, `games/${gameCode}`));
        const d = s.val();
        const players = Object.keys(d.players);
        const cat = document.getElementById('categorySelect').value;
        const randomWord = categories[cat][Math.floor(Math.random() * 30)];
        await update(ref(db, `games/${gameCode}`), {
            status: 'playing', word: randomWord, turn: 0, playerOrder: players,
            impostor: players[Math.floor(Math.random() * players.length)]
        });
    };

    document.getElementById('btnNext').onclick = async () => {
        const s = await get(ref(db, `games/${gameCode}`));
        const d = s.val();
        await update(ref(db, `games/${gameCode}`), { turn: (d.turn + 1) % d.playerOrder.length });
    };
</script>
</body>
</html>
