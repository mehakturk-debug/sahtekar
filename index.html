<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ä°mpostor Pro - DM & SÄ±ralÄ± Ses</title>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --red: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        .container { background: var(--card); border-radius: 24px; padding: 20px; width: 95%; max-width: 900px; height: 90vh; display: flex; gap: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
        
        /* Ana Oyun AlanÄ± */
        .main-game { flex: 2; display: flex; flex-direction: column; justify-content: space-between; position: relative; }
        
        /* SaÄŸ Panel (Oyuncular) */
        .side-panel { flex: 0.8; background: rgba(0,0,0,0.2); border-radius: 20px; padding: 15px; overflow-y: auto; border-left: 1px solid #334155; }
        .side-player { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 12px; cursor: pointer; transition: 0.3s; margin-bottom: 10px; background: #334155; border: 2px solid transparent; }
        .side-player:hover { background: #475569; border-color: var(--accent); }
        .side-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #64748b; }
        
        /* Ekranlar */
        .screen { display: none; width: 100%; height: 100%; }
        .active { display: flex; flex-direction: column; }
        
        /* GiriÅŸ ve Renkler */
        .player-opt { background: #334155; padding: 10px; border-radius: 12px; text-align: center; cursor: pointer; border: 2px solid transparent; }
        .player-opt.selected { border-color: var(--accent); }
        .avatar-preview { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-bottom: 5px; }
        
        /* Oyun Elementleri */
        #micBtn { width: 100px; height: 100px; border-radius: 50%; background: #475569; border: none; color: white; font-size: 40px; margin: 20px auto; cursor: not-allowed; opacity: 0.3; transition: 0.3s; }
        #micBtn.my-turn { cursor: pointer; opacity: 1; background: var(--accent); }
        #micBtn.recording { background: var(--red); box-shadow: 0 0 30px var(--red); transform: scale(1.1); }
        .turn-box { padding: 20px; border-radius: 20px; text-align: center; border: 2px solid rgba(255,255,255,0.1); }
        .word-display { background: rgba(0,0,0,0.4); padding: 15px; border-radius: 15px; font-size: 20px; text-align: center; font-weight: bold; margin: 10px 0; border-bottom: 3px solid var(--accent); }

        /* Ã–zel Mesaj Penceresi */
        .dm-window { position: fixed; bottom: 20px; right: 20px; width: 300px; background: #1e293b; border: 2px solid var(--accent); border-radius: 15px; padding: 15px; display: none; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .dm-messages { height: 150px; overflow-y: auto; margin-bottom: 10px; font-size: 13px; }
        .dm-msg-in { color: #38bdf8; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="main-game">
        <div id="homeScreen" class="screen active">
            <h2 style="text-align:center; color:var(--accent)">ğŸ­ Ekip GiriÅŸ</h2>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-bottom:20px;">
                <div class="player-opt" data-name="Mehmet"><img src="" class="avatar-preview" id="img-Mehmet"><span>Mehmet</span></div>
                <div class="player-opt" data-name="Emre"><img src="" class="avatar-preview" id="img-Emre"><span>Emre</span></div>
                <div class="player-opt" data-name="Recep"><img src="" class="avatar-preview" id="img-Recep"><span>Recep</span></div>
                <div class="player-opt" data-name="Furkan"><img src="" class="avatar-preview" id="img-Furkan"><span>Furkan</span></div>
                <div class="player-opt" data-name="Ali"><img src="" class="avatar-preview" id="img-Ali"><span>Ali</span></div>
            </div>
            <label style="text-align:center; display:block; cursor:pointer; background:#334155; padding:10px; border-radius:10px;">
                ğŸ“· FotoÄŸraf SeÃ§
                <input type="file" id="photoUpload" accept="image/*" style="display:none">
            </label>
            <input type="text" id="room" placeholder="Oyun Kodu">
            <button id="btnJoin">BAÄLAN</button>
        </div>

        <div id="gameScreen" class="screen">
            <div id="turnPanel" class="turn-box">
                <img id="activeUserPhoto" style="width:70px; height:70px; border-radius:50%; border:3px solid var(--accent);">
                <h2 id="activeName" style="margin:5px 0;">SÄ±ra Kimde?</h2>
            </div>
            <div id="wordBox" class="word-display"></div>
            <button id="micBtn">ğŸ™ï¸</button>
            <p id="micStatus" style="text-align:center; font-size:12px; color:#94a3b8">SÄ±ranÄ± Bekle...</p>
            <button id="btnNext" style="display:none; background:#f59e0b">SIRADAKÄ° OYUNCU â”</button>
        </div>
    </div>

    <div id="sidePanel" class="side-panel">
        <h4 style="margin-top:0; color:var(--accent); text-align:center;">ğŸ‘¥ OYUNCULAR</h4>
        <div id="sidePlayerList"></div>
    </div>
</div>

<div id="dmWindow" class="dm-window">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <span id="dmTargetName" style="font-weight:bold; color:var(--accent)"></span>
        <button onclick="document.getElementById('dmWindow').style.display='none'" style="width:30px; padding:2px; margin:0;">X</button>
    </div>
    <div id="dmMessages" class="dm-messages"></div>
    <div style="display:flex; gap:5px;">
        <input type="text" id="dmInput" placeholder="Mesaj yaz..." style="margin:0; padding:8px;">
        <button id="btnSendDM" style="width:60px; padding:0; margin:0;">GÃ–NDER</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBcm1uY37IelMsTqoD0sAmsIH1nwBeYtCE",
        authDomain: "sahtekar-2f5d2.firebaseapp.com",
        databaseURL: "https://sahtekar-2f5d2-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "sahtekar-2f5d2",
        appId: "1:223883537002:web:1c16bde374d11efb5d7813"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = "", myPhoto = "", gameCode = "", mediaRecorder, audioChunks = [], selectedDMUser = "";

    // FotoÄŸraf YÃ¼kleme
    window.onload = () => {
        ['Mehmet', 'Emre', 'Recep', 'Furkan', 'Ali'].forEach(n => {
            const s = localStorage.getItem('photo-'+n);
            if(s) document.getElementById('img-'+n).src = s;
        });
    };

    document.querySelectorAll('.player-opt').forEach(opt => {
        opt.onclick = () => {
            document.querySelectorAll('.player-opt').forEach(e => e.classList.remove('selected'));
            opt.classList.add('selected');
            myName = opt.dataset.name;
            myPhoto = localStorage.getItem('photo-'+myName) || "";
        };
    });

    document.getElementById('photoUpload').onchange = (e) => {
        if(!myName) return alert("Ã–nce isim seÃ§!");
        const r = new FileReader();
        r.onload = () => {
            localStorage.setItem('photo-'+myName, r.result);
            document.getElementById('img-'+myName).src = r.result;
            myPhoto = r.result;
        };
        r.readAsDataURL(e.target.files[0]);
    };

    // --- SES SÄ°STEMÄ° (HQ) ---
    async function startRec() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true } });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
            const r = new FileReader();
            r.readAsDataURL(new Blob(audioChunks));
            r.onloadend = () => update(ref(db, `games/${gameCode}/lastAudio`), { sender: myName, data: r.result, time: Date.now() });
            audioChunks = [];
        };
        mediaRecorder.start();
        document.getElementById('micBtn').classList.add('recording');
    }

    function stopRec() {
        if(mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
            document.getElementById('micBtn').classList.remove('recording');
        }
    }

    const mBtn = document.getElementById('micBtn');
    mBtn.onmousedown = () => { if(mBtn.classList.contains('my-turn')) startRec(); };
    mBtn.onmouseup = stopRec;
    mBtn.ontouchstart = (e) => { e.preventDefault(); if(mBtn.classList.contains('my-turn')) startRec(); };
    mBtn.ontouchend = stopRec;

    // --- OYUN GÄ°RÄ°Å VE LÄ°STEN ---
    document.getElementById('btnJoin').onclick = async () => {
        if(!myName) return alert("Ä°sim seÃ§!");
        gameCode = document.getElementById('room').value.trim().toUpperCase() || Math.random().toString(36).substring(2,6).toUpperCase();
        
        const snap = await get(ref(db, `games/${gameCode}`));
        if(!snap.exists()) await set(ref(db, `games/${gameCode}`), { status: 'waiting', moderator: myName });
        
        await update(ref(db, `games/${gameCode}/players/${myName}`), { name: myName, photo: myPhoto });
        document.getElementById('homeScreen').classList.remove('active');
        document.getElementById('gameScreen').classList.add('active');
        listen();
    };

    function listen() {
        onValue(ref(db, `games/${gameCode}`), (s) => {
            const d = s.val(); if(!d) return;
            const players = d.players || {};
            
            // SaÄŸ Panel GÃ¼ncelleme
            const sideList = document.getElementById('sidePlayerList');
            sideList.innerHTML = Object.values(players).map(p => `
                <div class="side-player" onclick="openDM('${p.name}')">
                    <img src="${p.photo}" class="side-avatar">
                    <span style="font-size:13px;">${p.name} ${p.name === d.moderator ? 'ğŸ‘‘' : ''}</span>
                </div>
            `).join('');

            // SÄ±ra ve KonuÅŸma Ä°zni
            if(d.status === 'playing') {
                const active = d.playerOrder[d.turn];
                document.getElementById('activeName').innerText = active;
                document.getElementById('activeUserPhoto').src = players[active]?.photo || "";
                document.getElementById('wordBox').innerText = (d.impostor === myName) ? "ğŸ­ Ä°MPOSTORSUN" : "Kelime: " + d.word;
                
                if(active === myName) {
                    mBtn.classList.add('my-turn');
                    document.getElementById('micStatus').innerText = "KONUÅABÄ°LÄ°RSÄ°N (BasÄ±lÄ± Tut)";
                } else {
                    mBtn.classList.remove('my-turn');
                    document.getElementById('micStatus').innerText = "SÄ±ra " + active + " kullanÄ±cÄ±sÄ±nda.";
                }
                document.getElementById('btnNext').style.display = (myName === d.moderator) ? 'block' : 'none';
            } else if(myName === d.moderator) {
                document.getElementById('btnNext').style.display = 'block';
                document.getElementById('btnNext').innerText = "OYUNU BAÅLAT";
            }
        });

        // Ses ve DM Dinleyicileri
        onValue(ref(db, `games/${gameCode}/lastAudio`), (s) => {
            const a = s.val(); if(a && a.sender !== myName) new Audio(a.data).play();
        });

        onValue(ref(db, `games/${gameCode}/dms/${myName}`), (s) => {
            if(s.exists()) {
                document.getElementById('dmWindow').style.display = 'block';
                const msgs = Object.values(s.val());
                document.getElementById('dmMessages').innerHTML = msgs.map(m => `<div class="dm-msg-in"><b>${m.from}:</b> ${m.txt}</div>`).join('');
                document.getElementById('dmMessages').scrollTop = 9999;
            }
        });
    }

    // --- DM FONKSÄ°YONLARI ---
    window.openDM = (target) => {
        if(target === myName) return;
        selectedDMUser = target;
        document.getElementById('dmWindow').style.display = 'block';
        document.getElementById('dmTargetName').innerText = target + " ile DM";
    };

    document.getElementById('btnSendDM').onclick = () => {
        const txt = document.getElementById('dmInput').value.trim();
        if(!txt) return;
        push(ref(db, `games/${gameCode}/dms/${selectedDMUser}`), { from: myName, txt: txt });
        document.getElementById('dmInput').value = "";
    };

    // --- MODERATÃ–R ---
    document.getElementById('btnNext').onclick = async () => {
        const s = await get(ref(db, `games/${gameCode}`));
        const d = s.val();
        if(d.status === 'playing') {
            update(ref(db, `games/${gameCode}`), { turn: (d.turn + 1) % d.playerOrder.length });
        } else {
            const plist = Object.keys(d.players);
            update(ref(db, `games/${gameCode}`), {
                status: 'playing', word: "HELÄ°KOPTER", turn: 0, playerOrder: plist,
                impostor: plist[Math.floor(Math.random() * plist.length)]
            });
        }
    };
</script>
</body>
</html>
