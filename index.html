<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ä°mpostor Pro - Ekip Ã–zel</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: var(--card); border-radius: 24px; padding: 25px; width: 95%; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .screen { display: none; }
        .active { display: block; }
        select, input { width: 100%; padding: 12px; margin: 10px 0; background: #334155; border: 1px solid #475569; color: white; border-radius: 12px; }
        button { width: 100%; padding: 15px; background: var(--accent); color: #0f172a; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.3s; }
        
        /* Oyuncu SeÃ§imi ve FotoÄŸraf */
        .player-select-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .player-opt { background: #334155; padding: 10px; border-radius: 12px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .player-opt.selected { border-color: var(--accent); background: #1e293b; }
        .avatar-preview { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin: 0 auto 5px; background: #475569; display: block; }
        
        #micBtn { width: 100px; height: 100px; border-radius: 50%; background: #475569; border: none; color: white; font-size: 40px; margin: 20px auto; display: block; cursor: pointer; transition: 0.2s; }
        #micBtn.recording { background: #ef4444; transform: scale(1.1); box-shadow: 0 0 30px #ef4444; }
        .turn-area { padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 15px; position: relative; }
        .user-photo-large { width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="homeScreen" class="screen active">
        <h1 style="text-align:center; color:var(--accent)">ğŸ­ Ekip Ä°mpostor</h1>
        
        <p style="text-align:center; font-size:14px;">Kimsin?</p>
        <div class="player-select-grid" id="playerSelect">
            <div class="player-opt" data-name="Mehmet">
                <img src="" class="avatar-preview" id="img-Mehmet"> <span>Mehmet</span>
            </div>
            <div class="player-opt" data-name="Emre">
                <img src="" class="avatar-preview" id="img-Emre"> <span>Emre</span>
            </div>
            <div class="player-opt" data-name="Recep">
                <img src="" class="avatar-preview" id="img-Recep"> <span>Recep</span>
            </div>
            <div class="player-opt" data-name="Furkan">
                <img src="" class="avatar-preview" id="img-Furkan"> <span>Furkan</span>
            </div>
            <div class="player-opt" data-name="Ali">
                <img src="" class="avatar-preview" id="img-Ali"> <span>Ali</span>
            </div>
        </div>

        <div style="text-align:center; margin-bottom:15px;">
            <label style="font-size:12px; color:var(--accent); cursor:pointer;">
                ğŸ“· FotoÄŸrafÄ±nÄ± YÃ¼kle/DeÄŸiÅŸtir
                <input type="file" id="photoUpload" accept="image/*" style="display:none">
            </label>
        </div>

        <input type="text" id="room" placeholder="Oyun Kodu">
        <button id="btnJoin">BAÄLAN VE GÄ°RÄ°Å YAP</button>
    </div>

    <div id="lobbyScreen" class="screen">
        <h2 style="text-align:center">Kod: <span id="roomDisplay" style="color:var(--accent)"></span></h2>
        <div id="playerList" style="text-align:center; margin:20px 0;"></div>
        
        <div id="modPanel" style="display:none; background:rgba(0,0,0,0.2); padding:15px; border-radius:15px;">
            <p style="color:var(--accent); font-weight:bold">ğŸ”§ ModeratÃ¶r AyarlarÄ±</p>
            <select id="categorySelect"></select>
            <button id="btnStart" style="background:#22c55e">OYUNU BAÅLAT</button>
        </div>
    </div>

    <div id="gameScreen" class="screen">
        <div id="turnPanel" class="turn-area">
            <img id="activeUserPhoto" class="user-photo-large" src="">
            <h2 id="activeName">SÄ±ra Kimde?</h2>
        </div>
        <div id="wordBox" style="text-align:center; padding:15px; background:rgba(0,0,0,0.2); border-radius:10px; font-weight:bold; font-size:22px;"></div>
        
        <button id="micBtn">ğŸ™ï¸</button>
        <button id="btnNext" style="display:none; background:#f59e0b; margin-top:20px;">SIRADAKÄ° â”</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBcm1uY37IelMsTqoD0sAmsIH1nwBeYtCE",
        authDomain: "sahtekar-2f5d2.firebaseapp.com",
        databaseURL: "https://sahtekar-2f5d2-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "sahtekar-2f5d2",
        appId: "1:223883537002:web:1c16bde374d11efb5d7813"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let myName = "", myPhoto = "", gameCode, mediaRecorder, audioChunks = [];

    // --- KATEGORÄ° VE KELÄ°MELER (10 Kategori x 30 Kelime) ---
    const categories = {
        "Meslekler": ["Doktor", "Pilot", "AÅŸÃ§Ä±", "MÃ¼hendis", "Avukat", "Ã–ÄŸretmen", "Polis", "YazÄ±lÄ±mcÄ±", "Mimar", "HemÅŸire", "Ã‡iftÃ§i", "Berber", "Kaptan", "BÃ¼yÃ¼kelÃ§i", "Gazeteci", "Psikolog", "SanatÃ§Ä±", "Astronot", "Hakim", "FÄ±rÄ±ncÄ±", "PostacÄ±", "BahÃ§Ä±van", "TercÃ¼man", "Muhasebeci", "ModacÄ±", "Veteriner", "DalgÄ±Ã§", "Ä°tfaiyeci", "Garson", "Dedektif"],
        "Hayvanlar": ["Aslan", "Fil", "ZÃ¼rafa", "Penguen", "Kaplan", "Maymun", "Yunus", "Kartal", "Kanguru", "Timsah", "Kurt", "AyÄ±", "Geyik", "Sincap", "TavÅŸan", "Kedi", "KÃ¶pek", "At", "Ä°nek", "ZÃ¼rafa", "Bukalemun", "Ahtapot", "Balina", "YÄ±lan", "ArÄ±", "Kelebek", "PapaÄŸan", "Penguen", "Koala", "Panda"],
        "Yemekler": ["MantÄ±", "Ä°skender", "Lahmacun", "Pizza", "Hamburger", "Kuru Fasulye", "Kebap", "DÃ¶ner", "SuÅŸi", "Makarna", "Baklava", "Pide", "BÃ¶rek", "KÄ±sÄ±r", "Menemen", "Ã‡orba", "Sarma", "Dolma", "MÃ¼cver", "GÃ¶zleme", "Salata", "Pilav", "KÃ¶fte", "Ä°Ã§li KÃ¶fte", "Tarhana", "Humus", "KÃ¼nefe", "GÃ¼llaÃ§", "SÃ¼tlaÃ§", "Lokum"],
        "Åehirler": ["Ä°stanbul", "Ankara", "Ä°zmir", "Londra", "Paris", "New York", "Tokyo", "Roma", "Berlin", "Moskova", "Kahire", "Madrid", "BakÃ¼", "Atina", "Amsterdam", "Viyana", "Prag", "Dubai", "Seul", "Pekin", "Sidney", "Venedik", "Barselona", "Lizbon", "Helsinki", "Oslo", "Stokholm", "VarÅŸova", "BudapeÅŸte", "Tahran"],
        "EÅŸyalar": ["Televizyon", "BuzdolabÄ±", "Ã‡amaÅŸÄ±r Makinesi", "ÃœtÃ¼", "Lamba", "Saat", "Ayna", "Koltuk", "Masa", "KitaplÄ±k", "Bilgisayar", "Telefon", "Kamera", "Radyo", "GÃ¶zlÃ¼k", "Anahtar", "CÃ¼zdan", "Åemsiye", "BÄ±Ã§ak", "KaÅŸÄ±k", "Ã‡atal", "Tabak", "Bardak", "Tencere", "FÄ±rÄ±n", "SÃ¼pÃ¼rge", "Tarak", "FÄ±rÃ§a", "YastÄ±k", "Battaniye"],
        "Sporlar": ["Futbol", "Basketbol", "Voleybol", "Tenis", "YÃ¼zme", "GÃ¼reÅŸ", "OkÃ§uluk", "Eskrim", "Boks", "Hentbol", "Bilardo", "Golf", "Kayak", "SÃ¶rf", "SatranÃ§", "Bowling", "Atletizm", "Jimnastik", "Karate", "Judo", "Bisiklet", "Binicilik", "Kano", "Rafting", "Yelken", "Dart", "Masa Tenisi", "Badminton", "DaÄŸcÄ±lÄ±k", "Paten"],
        "Filmler/Diziler": ["Kurtlar Vadisi", "Ezel", "Avrupa YakasÄ±", "Harry Potter", "YÃ¼zÃ¼klerin Efendisi", "Star Wars", "Titanik", "Matrix", "Ã–rÃ¼mcek Adam", "Batman", "Aslan Kral", "Hababam SÄ±nÄ±fÄ±", "Gora", "Ayla", "Babam ve OÄŸlum", "Vizontele", "Ã‡iÃ§ek Abbas", "Tosun PaÅŸa", "SÃ¼t KardeÅŸler", "Åaban OÄŸlu Åaban", "NeÅŸeli GÃ¼nler", "Selvi Boylum Al YazmalÄ±m", "Game of Thrones", "Breaking Bad", "Sherlock", "Prison Break", "La Casa De Papel", "Stranger Things", "Dark", "Friends"],
        "Teknoloji": ["Yapay Zeka", "Robot", "Ä°nternet", "MikroÃ§ip", "Uydu", "Drone", "Blockchain", "Metaverse", "Bluetooth", "Wi-Fi", "Lazer", "Kripto Para", "AkÄ±llÄ± Saat", "Sanal GerÃ§eklik", "YazÄ±lÄ±m", "DonanÄ±m", "Sunucu", "Bulut BiliÅŸim", "Siber GÃ¼venlik", "Algoritma", "Kodlama", "VeritabanÄ±", "Ä°ÅŸlemci", "Ekran KartÄ±", "Anakart", "Klavye", "Fare", "KulaklÄ±k", "HoparlÃ¶r", "YazÄ±cÄ±"],
        "Meyveler/Sebzeler": ["Elma", "Armut", "Muz", "Ã‡ilek", "Karpuz", "Kavun", "Erik", "Kiraz", "ViÅŸne", "ÃœzÃ¼m", "Ä°ncir", "Nar", "Portakal", "Mandalina", "Limon", "Domates", "SalatalÄ±k", "Biber", "PatlÄ±can", "Patates", "SoÄŸan", "SarÄ±msak", "Kabak", "Ispanak", "PÄ±rasa", "Lahana", "Karnabahar", "Brokoli", "HavuÃ§", "Bezelye"],
        "Hobiler": ["FotoÄŸraf Ã‡ekmek", "Resim Yapmak", "Gitar Ã‡almak", "Kitap Okumak", "Kamp Yapmak", "BalÄ±k Tutmak", "Dans Etmek", "Yemek PiÅŸirmek", "BahÃ§e Ä°ÅŸleri", "Ã–rgÃ¼ Ã–rmek", "Model UÃ§ak", "Pul Koleksiyonu", "YÃ¼rÃ¼yÃ¼ÅŸ", "Yoga", "Meditasyon", "Puzzle", "Video OyunlarÄ±", "Seyahat Etmek", "YazÄ± Yazmak", "Heykel Yapmak", "Seramik", "Koleksiyonculuk", "Origami", "Marangozluk", "DikiÅŸ Dikmek", "KuÅŸ GÃ¶zlemciliÄŸi", "GÃ¶kbilim", "Tiyatro", "Sinemaya Gitmek", "Konser Ä°zlemek"]
    };

    // --- FOTOÄRAF VE OYUNCU SEÃ‡Ä°MÄ° SÄ°STEMÄ° ---
    window.onload = () => {
        const catSelect = document.getElementById('categorySelect');
        Object.keys(categories).forEach(cat => {
            let opt = document.createElement('option');
            opt.value = cat; opt.innerText = cat;
            catSelect.appendChild(opt);
        });

        // KayÄ±tlÄ± fotoÄŸraflarÄ± yÃ¼kle
        ['Mehmet', 'Emre', 'Recep', 'Furkan', 'Ali'].forEach(name => {
            const saved = localStorage.getItem('photo-' + name);
            if(saved) document.getElementById('img-' + name).src = saved;
        });
    };

    document.querySelectorAll('.player-opt').forEach(opt => {
        opt.onclick = () => {
            document.querySelectorAll('.player-opt').forEach(e => e.classList.remove('selected'));
            opt.classList.add('selected');
            myName = opt.dataset.name;
            myPhoto = localStorage.getItem('photo-' + myName) || "";
        };
    });

    document.getElementById('photoUpload').onchange = (e) => {
        if(!myName) return alert("Ã–nce adÄ±nÄ± seÃ§!");
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onloadend = () => {
            localStorage.setItem('photo-' + myName, reader.result);
            document.getElementById('img-' + myName).src = reader.result;
            myPhoto = reader.result;
        };
        reader.readAsDataURL(file);
    };

    // --- SES KAYIT SÄ°STEMÄ° ---
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
            const reader = new FileReader();
            reader.readAsDataURL(new Blob(audioChunks));
            reader.onloadend = () => {
                update(ref(db, `games/${gameCode}/lastAudio`), { sender: myName, data: reader.result, time: Date.now() });
            };
            audioChunks = [];
        };
    });

    const micBtn = document.getElementById('micBtn');
    const startRec = () => { if(mediaRecorder) { mediaRecorder.start(); micBtn.classList.add('recording'); } };
    const stopRec = () => { if(mediaRecorder && mediaRecorder.state !== "inactive") { mediaRecorder.stop(); micBtn.classList.remove('recording'); } };
    micBtn.onmousedown = startRec; micBtn.onmouseup = stopRec;
    micBtn.ontouchstart = (e) => { e.preventDefault(); startRec(); }; micBtn.ontouchend = stopRec;

    // --- GÄ°RÄ°Å VE OYUN MANTIÄI ---
    document.getElementById('btnJoin').onclick = async () => {
        if(!myName) return alert("Kim olduÄŸunu seÃ§medin!");
        let c = document.getElementById('room').value.trim().toUpperCase();
        gameCode = c || Math.random().toString(36).substring(2,6).toUpperCase();
        
        if(!c) await set(ref(db, `games/${gameCode}`), { status: 'waiting', moderator: myName });
        await update(ref(db, `games/${gameCode}/players/${myName}`), { name: myName, photo: myPhoto });

        document.getElementById('homeScreen').classList.remove('active');
        document.getElementById('lobbyScreen').classList.add('active');
        document.getElementById('roomDisplay').innerText = gameCode;
        listen();
    };

    function listen() {
        onValue(ref(db, `games/${gameCode}`), (s) => {
            const d = s.val(); if(!d) return;
            const players = d.players || {};
            
            // Lobi oyuncu listesi
            const list = document.getElementById('playerList');
            list.innerHTML = "";
            Object.values(players).forEach(p => {
                list.innerHTML += `<div style="display:inline-block; margin:10px; text-align:center;">
                    <img src="${p.photo}" style="width:50px; height:50px; border-radius:50%; display:block; margin:0 auto; border:2px solid #38bdf8;">
                    <span style="font-size:12px;">${p.name}</span>
                </div>`;
            });

            const isMod = myName === d.moderator;
            document.getElementById('modPanel').style.display = (isMod && d.status === 'waiting') ? 'block' : 'none';
            document.getElementById('waitingMsg')?.remove();
            if(!isMod && d.status === 'waiting') {
                let p = document.createElement('p'); p.id="waitingMsg"; p.innerText="ModeratÃ¶r bekleniyor..."; p.style.textAlign="center";
                document.getElementById('lobbyScreen').appendChild(p);
            }

            if(d.status === 'playing') {
                document.getElementById('lobbyScreen').classList.remove('active');
                document.getElementById('gameScreen').classList.add('active');
                const active = d.playerOrder[d.turn];
                const activeP = Object.values(players).find(p => p.name === active);
                document.getElementById('activeName').innerText = active;
                document.getElementById('activeUserPhoto').src = activeP?.photo || "";
                document.getElementById('wordBox').innerText = (d.impostor === myName) ? "ğŸ­ Ä°MPOSTORSUN" : "Kelime: " + d.word;
                document.getElementById('btnNext').style.display = isMod ? 'block' : 'none';
            }
        });

        onValue(ref(db, `games/${gameCode}/lastAudio`), (s) => {
            const audio = s.val();
            if(audio && audio.sender !== myName) new Audio(audio.data).play();
        });
    }

    document.getElementById('btnStart').onclick = async () => {
        const s = await get(ref(db, `games/${gameCode}`));
        const d = s.val();
        const players = Object.keys(d.players);
        const cat = document.getElementById('categorySelect').value;
        const wordList = categories[cat];
        const randomWord = wordList[Math.floor(Math.random() * wordList.length)];
        
        await update(ref(db, `games/${gameCode}`), {
            status: 'playing', word: randomWord, turn: 0, playerOrder: players,
            impostor: players[Math.floor(Math.random() * players.length)]
        });
    };

    document.getElementById('btnNext').onclick = async () => {
        const s = await get(ref(db, `games/${gameCode}`));
        const d = s.val();
        await update(ref(db, `games/${gameCode}`), { turn: (d.turn + 1) % d.playerOrder.length });
    };
</script>
</body>
</html>
