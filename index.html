<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Hangman Arena</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --red: #ef4444; --green: #22c55e; --orange: #f59e0b; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        
        .container { background: var(--card); border-radius: 20px; width: 95%; max-width: 800px; height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid #334155; position: relative; }
        
        /* Ãœst Profil Paneli (Dinamik SÄ±ralama) */
        .player-bar { display: flex; justify-content: center; gap: 10px; padding: 15px; background: rgba(0,0,0,0.2); border-bottom: 1px solid #334155; height: 70px; }
        .p-card { background: #334155; padding: 5px 12px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; min-width: 80px; position: relative; border: 1px solid transparent; transition: 0.3s; }
        .p-card.rank-1 { border-color: gold; transform: scale(1.1); z-index: 2; }
        .rank-tag { font-size: 10px; font-weight: bold; color: var(--orange); }

        .screen { display: none; flex: 1; flex-direction: column; justify-content: center; align-items: center; padding: 20px; overflow-y: auto; }
        .active { display: flex; }

        /* Ayarlar EkranÄ± */
        .settings-box { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        label { font-size: 12px; opacity: 0.8; }
        input { padding: 10px; border-radius: 8px; border: 1px solid #475569; background: #0f172a; color: white; width: 80%; }

        /* Oyun AlanÄ± */
        .game-info { width: 100%; display: flex; justify-content: space-around; margin-bottom: 10px; font-weight: bold; color: var(--accent); }
        .word-box { font-size: clamp(24px, 6vw, 42px); letter-spacing: 5px; margin: 20px 0; font-family: monospace; }
        .keyboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(40px, 1fr)); gap: 5px; width: 100%; max-width: 500px; }
        .key { background: #475569; padding: 10px 0; border-radius: 8px; cursor: pointer; user-select: none; border-bottom: 3px solid #1e293b; }
        .key.used { opacity: 0.2; pointer-events: none; }

        .mic-btn { background: var(--red); width: 60px; height: 60px; border-radius: 50%; margin-top: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); }
        .mic-btn.active { animation: pulse 1s infinite; background: var(--green); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }

        button { background: var(--accent); color: #0f172a; border: none; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; max-width: 300px; margin-top: 15px; }
        
        #finalBoard { background: rgba(0,0,0,0.5); width: 100%; border-radius: 15px; padding: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div class="player-bar" id="playerBar"></div>

    <div id="setupScreen" class="screen active">
        <h2>Oyun Kurulumu</h2>
        <div class="settings-box">
            <div>
                <label>AdÄ±n:</label><br>
                <input type="text" id="pNameInput" placeholder="Ä°smin...">
            </div>
            <div>
                <label>Maks. Hata:</label><br>
                <input type="number" id="maxErrors" value="6">
            </div>
            <div>
                <label>Soru SayÄ±sÄ±:</label><br>
                <input type="number" id="totalQ" value="10">
            </div>
            <div>
                <label>SÃ¼re (Dakika):</label><br>
                <input type="number" id="totalTime" value="5">
            </div>
        </div>
        <button onclick="joinGame()">OYUNU BAÅžLAT / KATIL</button>
    </div>

    <div id="gameScreen" class="screen">
        <div class="game-info">
            <span id="timer">Kalan: 00:00</span>
            <span id="qCount">Soru: 1/10</span>
            <span id="localScore">Puan: 0</span>
        </div>
        <div id="catName" style="color:var(--orange)">Kategori</div>
        <div class="word-box" id="wordBox">_ _ _ _</div>
        <div id="mistakeInfo" style="color:var(--red); margin-bottom:10px;">Hata: 0/6</div>
        
        <div class="keyboard" id="keyboard"></div>

        <div class="mic-btn" id="micBtn" onclick="toggleMic()">
            ðŸŽ¤
        </div>
    </div>

    <div id="finalScreen" class="screen">
        <h2 style="color:var(--green)">YarÄ±ÅŸma TamamlandÄ±!</h2>
        <div id="finalBoard"></div>
        <button onclick="location.reload()">TEKRAR OYNA</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBcm1uY37IelMsTqoD0sAmsIH1nwBeYtCE",
        authDomain: "sahtekar-2f5d2.firebaseapp.com",
        databaseURL: "https://sahtekar-2f5d2-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "sahtekar-2f5d2",
        appId: "1:223883537002:web:1c16bde374d11efb5d7813"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = "", roomID = "COMPETITION_ROOM_01";
    let localGuesses = [], localMistakes = 0, currentQ = 1, myPoints = 0, isGameLive = false;
    let timerInterval;

    const correctAudio = new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3');
    const wrongAudio = new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3');

    const wordPool = ["ELMA", "YAZILIM", "Ä°STANBUL", "TELEFON", "BÄ°LGÄ°SAYAR", "TÃœRKÄ°YE", "MÃœHENDÄ°S", "KLAVYE", "GÃœNEÅž", "DENÄ°Z"];

    window.joinGame = async () => {
        myName = document.getElementById('pNameInput').value.trim();
        if(!myName) return alert("Ä°sim yaz!");

        const rRef = ref(db, `games/${roomID}`);
        const snap = await get(rRef);
        
        if(!snap.exists()) {
            const config = {
                status: 'PLAYING',
                maxErrors: parseInt(document.getElementById('maxErrors').value),
                totalQ: parseInt(document.getElementById('totalQ').value),
                limitTime: parseInt(document.getElementById('totalTime').value) * 60,
                startTime: Date.now(),
                currentWord: wordPool[0],
                players: {}
            };
            await set(rRef, config);
        }

        await update(ref(db, `games/${roomID}/players/${myName}`), { 
            name: myName, score: 0, mistakes: 0, completed: false, lastQ: 1 
        });

        document.getElementById('setupScreen').classList.remove('active');
        document.getElementById('gameScreen').classList.add('active');
        startListener();
    };

    function startListener() {
        onValue(ref(db, `games/${roomID}`), (snap) => {
            const d = snap.val(); if(!d) return;
            renderProfiles(d.players);
            
            if(!isGameLive) {
                isGameLive = true;
                startTimer(d.limitTime, d.startTime);
            }

            if(d.players[myName].completed) {
                showFinal(d);
                return;
            }

            renderGame(d);
        });
    }

    function renderProfiles(players) {
        const sorted = Object.values(players).sort((a,b) => b.score - a.score);
        document.getElementById('playerBar').innerHTML = sorted.map((p, i) => `
            <div class="p-card ${i===0?'rank-1':''}">
                <span class="rank-tag">#${i+1}</span>
                <span style="font-size:12px">${p.name}</span>
                <b style="color:var(--accent)">${p.score}</b>
            </div>
        `).join('');
    }

    function renderGame(d) {
        document.getElementById('qCount').innerText = `Soru: ${currentQ}/${d.totalQ}`;
        document.getElementById('mistakeInfo').innerText = `Hata: ${localMistakes}/${d.maxErrors}`;
        document.getElementById('localScore').innerText = `Puan: ${myPoints}`;

        let display = "";
        d.currentWord.split('').forEach(l => display += localGuesses.includes(l) ? l + " " : "_ ");
        document.getElementById('wordBox').innerText = display;

        const alf = "ABCÃ‡DEFGÄžHIÄ°JKLMNOÃ–PRSÅžTUÃœVYZ".split('');
        const kb = document.getElementById('keyboard');
        kb.innerHTML = "";
        alf.forEach(l => {
            const btn = document.createElement('div');
            btn.className = `key ${localGuesses.includes(l) ? 'used' : ''}`;
            btn.innerText = l;
            btn.onclick = () => handleInput(l, d);
            kb.appendChild(btn);
        });

        if(display.replace(/ /g, '') === d.currentWord) {
            handleNextRound(d);
        }
    }

    function handleInput(l, d) {
        if(localGuesses.includes(l)) return;
        localGuesses.push(l);
        if(d.currentWord.includes(l)) {
            correctAudio.play();
            myPoints += 10;
        } else {
            wrongAudio.play();
            localMistakes++;
            if(localMistakes >= d.maxErrors) {
                myPoints = Math.max(0, myPoints - 5);
                handleNextRound(d);
            }
        }
        update(ref(db, `games/${roomID}/players/${myName}`), { score: myPoints, mistakes: localMistakes });
    }

    async function handleNextRound(d) {
        if(currentQ >= d.totalQ) {
            clearInterval(timerInterval);
            await update(ref(db, `games/${roomID}/players/${myName}`), { completed: true, finishTime: Date.now() });
        } else {
            currentQ++;
            localGuesses = [];
            localMistakes = 0;
            const nextW = wordPool[currentQ % wordPool.length];
            await update(ref(db, `games/${roomID}`), { currentWord: nextW });
        }
    }

    function startTimer(limit, start) {
        timerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - start) / 1000);
            const remaining = limit - elapsed;
            if(remaining <= 0) {
                clearInterval(timerInterval);
                update(ref(db, `games/${roomID}/players/${myName}`), { completed: true });
            }
            const m = Math.floor(remaining / 60);
            const s = remaining % 60;
            document.getElementById('timer').innerText = `Kalan: ${m}:${s<10?'0':''}${s}`;
        }, 1000);
    }

    function showFinal(d) {
        document.getElementById('gameScreen').classList.remove('active');
        document.getElementById('finalScreen').classList.add('active');
        const p = d.players[myName];
        const timeSpent = Math.floor((p.finishTime - d.startTime) / 1000);
        document.getElementById('finalBoard').innerHTML = `
            <h3>Tebrikler ${myName}!</h3>
            <p>Toplam Puan: ${p.score}</p>
            <p>Toplam Hata: ${p.mistakes}</p>
            <p>Tamamlama SÃ¼resi: ${timeSpent} saniye</p>
        `;
    }

    // SES TANIMA (MÄ°KROFON)
    let recognition;
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.lang = 'tr-TR';
        recognition.onresult = (e) => {
            const letter = e.results[0][0].transcript.toUpperCase()[0];
            const event = new CustomEvent('voiceInput', { detail: letter });
            handleInput(letter, {currentWord: document.getElementById('wordBox').innerText.replace(/ /g, '')});
            document.getElementById('micBtn').classList.remove('active');
        };
    }

    window.toggleMic = () => {
        if(!recognition) return alert("TarayÄ±cÄ± desteklemiyor.");
        recognition.start();
        document.getElementById('micBtn').classList.add('active');
    };
</script>
</body>
</html>
