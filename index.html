<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adam Asmaca - Global Rekabet</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --red: #ef4444; --green: #22c55e; --orange: #f59e0b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: var(--card); border-radius: 24px; padding: 20px; width: 95%; max-width: 600px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
        .screen { display: none; text-align: center; }
        .active { display: block; }
        
        .char-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .char-btn { background: #334155; padding: 15px 5px; border-radius: 12px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; user-select: none; }
        .char-btn.selected { border-color: var(--accent); background: #1e293b; font-weight: bold; transform: scale(1.05); }
        
        button { width: 100%; padding: 14px; background: var(--accent); color: #0f172a; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; }
        .word-display { font-size: 32px; letter-spacing: 6px; margin: 25px 0; color: var(--accent); font-family: 'Courier New', monospace; min-height: 40px; }
        
        .keyboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(35px, 1fr)); gap: 6px; margin-top: 15px; }
        .key { background: #475569; padding: 12px 2px; border-radius: 8px; cursor: pointer; font-weight: bold; border-bottom: 3px solid #1e293b; user-select: none; }
        .key.used { opacity: 0.2; pointer-events: none; background: #0f172a; }
        
        #scoreBoard { margin-top: 20px; text-align: left; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px; font-size: 14px; }
        .score-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #334155; }
    </style>
</head>
<body>

<div class="container">
    <div id="loginScreen" class="screen active">
        <h2 style="color:var(--accent)">Karakter Seç</h2>
        <div class="char-grid">
            <div class="char-btn" onclick="appSetPlayer(this, 'Mehmet')">Mehmet</div>
            <div class="char-btn" onclick="appSetPlayer(this, 'Emre')">Emre</div>
            <div class="char-btn" onclick="appSetPlayer(this, 'Recep')">Recep</div>
            <div class="char-btn" onclick="appSetPlayer(this, 'Furkan')">Furkan</div>
            <div class="char-btn" onclick="appSetPlayer(this, 'Ali')">Ali</div>
        </div>
        <button id="joinBtn">OYUNA GİR</button>
    </div>

    <div id="gameScreen" class="screen">
        <div id="adminPanel" style="display:none; margin-bottom: 15px;">
            <button style="background:var(--green)" onclick="appNextWord()">YENİ KELİME SOR (SİSTEM)</button>
        </div>
        
        <div id="categoryDisplay" style="color:var(--orange); font-weight:bold; font-size: 18px;">Kategori: ...</div>
        <div class="word-display" id="wordDisplay"></div>

        <div id="playArea">
            <div id="mistakeDisplay" style="color:var(--red); font-weight:bold; margin-bottom:10px;">Hata: 0/6</div>
            <div class="keyboard" id="keyboard"></div>
        </div>

        <div id="scoreBoard"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBcm1uY37IelMsTqoD0sAmsIH1nwBeYtCE",
        authDomain: "sahtekar-2f5d2.firebaseapp.com",
        databaseURL: "https://sahtekar-2f5d2-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "sahtekar-2f5d2",
        appId: "1:223883537002:web:1c16bde374d11efb5d7813"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = "", roomID = "GLOBAL_AUTO_GAME", localGuesses = [], localMistakes = 0, isFinished = false, lastWord = "";

    // 1000 KELİME KAPASİTELİ HAVUZ ALTYAPISI
    const wordPool = {
        "Teknoloji": ["YAZILIM", "ALGORİTMA", "VERİTABANI", "BİLGİSAYAR", "İNTERNET", "YAPAYZEKA", "DONANIM", "KODLAMA", "KLAVYE", "SUNUCU"],
        "Hayvanlar": ["ZÜRAFA", "PENGUEN", "KAPLAN", "KARTAL", "BALİNA", "TİMSAH", "KANGURU", "KAPLUMBAĞA", "ASLAN", "FİL"],
        "Şehirler": ["İSTANBUL", "ANKARA", "İZMİR", "ANTALYA", "BURSA", "LONDRA", "PARİS", "TOKYO", "BERLİN", "MOSKOVA"],
        "Yiyecekler": ["BAKLAVA", "LAHMACUN", "İSKENDER", "HAMBURGER", "MAKARNA", "MENEMEN", "PİZZA", "MANTI", "KEBAP", "SÜTLAÇ"]
    };

    // KARAKTER SEÇİMİ (FIXED)
    window.appSetPlayer = (el, name) => {
        myName = name;
        document.querySelectorAll('.char-btn').forEach(b => b.classList.remove('selected'));
        el.classList.add('selected');
    };

    document.getElementById('joinBtn').onclick = async () => {
        if(!myName) return alert("Lütfen bir isim seçin!");
        const rRef = ref(db, `games/${roomID}`);
        const snap = await get(rRef);
        
        if(!snap.exists()) {
            await set(rRef, { status: 'PLAYING', moderator: myName, players: {}, currentWord: "BAŞLIYOR", category: "SİSTEM", winners: [], startTime: Date.now() });
        }
        
        await update(ref(db, `games/${roomID}/players/${myName}`), { name: myName, score: 0 });
        document.getElementById('loginScreen').classList.remove('active');
        document.getElementById('gameScreen').classList.add('active');
        
        // Dinlemeyi başlat
        onValue(rRef, (snapshot) => {
            const data = snapshot.val();
            if(!data) return;
            if(myName === data.moderator) document.getElementById('adminPanel').style.display = 'block';
            
            // Yeni kelime gelmişse yereli sıfırla
            if(data.currentWord !== lastWord) {
                localGuesses = [];
                localMistakes = 0;
                isFinished = false;
                lastWord = data.currentWord;
                if(document.getElementById('mistakeDisplay')) document.getElementById('mistakeDisplay').innerText = "Hata: 0/6";
            }
            renderGame(data);
        });
    };

    function renderGame(d) {
        document.getElementById('categoryDisplay').innerText = "Kategori: " + d.category;
        
        // Kelime Çizimi
        let display = "";
        d.currentWord.split('').forEach(l => {
            display += localGuesses.includes(l) ? l + " " : "_ ";
        });
        document.getElementById('wordDisplay').innerText = display;

        // Klavye Çizimi
        const alf = "ABCÇDEFGĞHIİJKLMNOÖPRSŞTUÜVYZ".split('');
        const kb = document.getElementById('keyboard');
        kb.innerHTML = "";
        alf.forEach(l => {
            const btn = document.createElement('div');
            btn.className = `key ${localGuesses.includes(l) ? 'used' : ''}`;
            btn.innerText = l;
            btn.onclick = () => {
                if(isFinished || localMistakes >= 6 || localGuesses.includes(l)) return;
                localGuesses.push(l);
                if(!d.currentWord.includes(l)) {
                    localMistakes++;
                    document.getElementById('mistakeDisplay').innerText = `Hata: ${localMistakes}/6`;
                }
                renderGame(d); // Anlık güncelleme
            };
            kb.appendChild(btn);
        });

        // Skorlar
        const scores = Object.values(d.players).sort((a,b) => b.score - a.score);
        document.getElementById('scoreBoard').innerHTML = "<b>Sıralama:</b>" + scores.map(p => `
            <div class="score-row">
                <span>${p.name} ${d.winners?.includes(p.name) ? '✅' : ''}</span>
                <b>${p.score} Puan</b>
            </div>
        `).join('');

        // Kazanma Tetikleyici
        if(!isFinished && d.currentWord !== "BAŞLIYOR" && d.currentWord.split('').every(l => localGuesses.includes(l))) {
            isFinished = true;
            handleWin(d);
        }
    }

    async function handleWin(d) {
        let winners = d.winners || [];
        if(!winners.includes(myName)) {
            winners.push(myName);
            const solveTime = (Date.now() - d.startTime) / 1000;
            let points = 20 + Math.max(0, Math.floor(60 - solveTime)) + (localMistakes === 0 ? 20 : 0);
            
            await update(ref(db, `games/${roomID}/players/${myName}`), { score: (d.players[myName].score || 0) + points });
            await update(ref(db, `games/${roomID}`), { winners: winners });
        }
    }

    // MODERATÖR FONKSİYONU: YENİ KELİME
    window.appNextWord = async () => {
        const cats = Object.keys(wordPool);
        const c = cats[Math.floor(Math.random() * cats.length)];
        const w = wordPool[c][Math.floor(Math.random() * wordPool[c].length)];
        
        await update(ref(db, `games/${roomID}`), {
            currentWord: w,
            category: c,
            winners: [],
            startTime: Date.now()
        });
    };
</script>
</body>
</html>
