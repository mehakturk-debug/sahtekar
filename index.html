<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Hangman Arena - 1000 Kelime</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --red: #ef4444; --green: #22c55e; --orange: #f59e0b; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        
        .container { background: var(--card); border-radius: 20px; width: 95%; max-width: 800px; height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid #334155; position: relative; }
        
        /* Dinamik Profil Paneli */
        .player-bar { display: flex; justify-content: center; gap: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-bottom: 1px solid #334155; overflow-x: auto; }
        .p-card { background: #334155; padding: 8px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; min-width: 70px; border: 2px solid transparent; transition: 0.3s; }
        .p-card.rank-1 { border-color: gold; transform: scale(1.05); }
        .p-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #1e293b; margin-bottom: 4px; }

        .screen { display: none; flex: 1; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; }
        .active { display: flex; }

        /* Karakter Se√ßimi */
        .char-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .char-btn { background: #334155; padding: 10px; border-radius: 12px; cursor: pointer; border: 2px solid transparent; }
        .char-btn.selected { border-color: var(--accent); background: #1e293b; }

        /* Oyun G√∂rseli */
        .word-display { font-size: clamp(24px, 5vw, 40px); letter-spacing: 6px; margin: 20px 0; font-family: 'Courier New', monospace; color: var(--accent); }
        .keyboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(35px, 1fr)); gap: 5px; width: 100%; max-width: 500px; }
        .key { background: #475569; padding: 10px 0; border-radius: 6px; cursor: pointer; font-weight: bold; user-select: none; }
        .key.used { opacity: 0.2; pointer-events: none; }

        input[type="number"], input[type="text"] { background: #0f172a; border: 1px solid #475569; color: white; padding: 8px; border-radius: 8px; width: 60px; margin: 5px; }
        button { background: var(--accent); color: #0f172a; border: none; padding: 15px 30px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 15px; width: 250px; }
        
        .mic-btn { background: var(--red); width: 50px; height: 50px; border-radius: 50%; margin-top: 15px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        .mic-btn.active { background: var(--green); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div class="container">
    <div class="player-bar" id="playerBar"></div>

    <div id="setupScreen" class="screen active">
        <h2>üé≠ Karakter Se√ß & Ba≈ülat</h2>
        <div class="char-grid">
            <div class="char-btn" onclick="selectChar('Mehmet')">Mehmet</div>
            <div class="char-btn" onclick="selectChar('Emre')">Emre</div>
            <div class="char-btn" onclick="selectChar('Recep')">Recep</div>
            <div class="char-btn" onclick="selectChar('Furkan')">Furkan</div>
            <div class="char-btn" onclick="selectChar('Ali')">Ali</div>
        </div>
        
        <div style="margin: 10px 0;">
            <label>Fotoƒüraf Y√ºkle:</label><br>
            <input type="file" id="avatarInput" accept="image/*" style="font-size: 10px;">
        </div>

        <div style="display: flex; gap: 10px; font-size: 12px;">
            <div>Soru: <input type="number" id="qCountInput" value="10"></div>
            <div>Hata: <input type="number" id="errorInput" value="6"></div>
            <div>S√ºre (dk): <input type="number" id="timeInput" value="5"></div>
        </div>
        
        <button onclick="joinGame()">YARI≈ûMAYI BA≈ûLAT</button>
    </div>

    <div id="gameScreen" class="screen">
        <div style="width:100%; display:flex; justify-content:space-between; font-size:12px; margin-bottom:10px;">
            <span id="timerText" style="color:var(--orange)">‚è± 00:00</span>
            <span id="progressText">Soru: 1/10</span>
        </div>
        <div id="categoryText" style="color:var(--orange); font-weight:bold; font-size: 18px;">Kategori: ...</div>
        <div class="word-display" id="wordDisplay">_ _ _ _</div>
        <div id="localMistakeText" style="color:var(--red); font-weight:bold; margin-bottom:10px;">Hata: 0/6</div>
        
        <div class="keyboard" id="keyboard"></div>
        
        <div class="mic-btn" id="micBtn" onclick="startVoice()">üé§</div>
    </div>

    <div id="finalScreen" class="screen">
        <h2 style="color:var(--green)">Yarƒ±≈üma Bitti!</h2>
        <div id="finalStats" style="background:rgba(0,0,0,0.2); padding:20px; border-radius:15px; width:80%;"></div>
        <button onclick="localStorage.clear(); location.reload();">YENƒ∞DEN BA≈ûLA</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBcm1uY37IelMsTqoD0sAmsIH1nwBeYtCE",
        authDomain: "sahtekar-2f5d2.firebaseapp.com",
        databaseURL: "https://sahtekar-2f5d2-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "sahtekar-2f5d2",
        appId: "1:223883537002:web:1c16bde374d11efb5d7813"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = "", myAvatar = "", roomID = "MEGA_HANGMAN_01";
    let localGuesses = [], localMistakes = 0, currentQ = 1, isFinished = false, score = 0;

    // 1000 Kelimelik Havuz √ñrneƒüi (Kƒ±saltƒ±lmƒ±≈ütƒ±r, aynƒ± mantƒ±kla geni≈ületilebilir)
    const wordPool = [
        {w: "ALGORƒ∞TMA", c: "Teknoloji"}, {w: "KLAVYE", c: "Teknoloji"}, {w: "ASLAN", c: "Hayvanlar"},
        {w: "ƒ∞SKENDER", c: "Yemekler"}, {w: "ANKARA", "c": "≈ûehirler"}, {w: "PENGUEN", "c": "Hayvanlar"}
        // 1000 kelime buraya eklenebilir.
    ];

    const correctSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3');
    const wrongSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3');

    // SAYFA YENƒ∞LENƒ∞NCE DEVAM ETME (LocalStorage)
    window.onload = () => {
        const saved = localStorage.getItem('hangman_state');
        if(saved) {
            const state = JSON.parse(saved);
            myName = state.name;
            myAvatar = state.avatar;
            currentQ = state.currentQ;
            score = state.score;
            joinGame(true);
        }
    };

    window.selectChar = (name) => {
        myName = name;
        document.querySelectorAll('.char-btn').forEach(b => b.classList.remove('selected'));
        event.target.classList.add('selected');
    };

    document.getElementById('avatarInput').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = () => myAvatar = reader.result;
        reader.readAsDataURL(e.target.files[0]);
    };

    window.joinGame = async (isResume = false) => {
        if(!myName) return alert("Karakter se√ß!");
        
        const rRef = ref(db, `games/${roomID}`);
        const snap = await get(rRef);

        if(!snap.exists() && !isResume) {
            await set(rRef, {
                status: 'PLAYING',
                maxErrors: parseInt(document.getElementById('errorInput').value),
                totalQ: parseInt(document.getElementById('qCountInput').value),
                limitTime: parseInt(document.getElementById('timeInput').value) * 60,
                startTime: Date.now(),
                words: wordPool.sort(() => 0.5 - Math.random()) // Kelimeleri karƒ±≈ütƒ±r
            });
        }

        await update(ref(db, `games/${roomID}/players/${myName}`), { 
            name: myName, avatar: myAvatar, score: score, finished: false 
        });

        document.getElementById('setupScreen').classList.remove('active');
        document.getElementById('gameScreen').classList.add('active');
        
        localStorage.setItem('hangman_state', JSON.stringify({name: myName, avatar: myAvatar, currentQ, score}));
        startSync();
    };

    function startSync() {
        onValue(ref(db, `games/${roomID}`), (snap) => {
            const d = snap.val(); if(!d) return;
            renderProfiles(d.players);
            if(!isFinished) runGame(d);
            updateTimer(d.startTime, d.limitTime);
        });
    }

    function renderProfiles(players) {
        const sorted = Object.values(players).sort((a,b) => b.score - a.score);
        document.getElementById('playerBar').innerHTML = sorted.map((p, i) => `
            <div class="p-card ${i===0?'rank-1':''}">
                <img src="${p.avatar || ''}" class="p-avatar">
                <span style="font-size:10px">${p.name}</span>
                <b style="color:var(--accent)">${p.score}</b>
            </div>
        `).join('');
    }

    function runGame(d) {
        const currentWordData = d.words[currentQ - 1];
        document.getElementById('categoryText').innerText = "Kategori: " + currentWordData.c;
        document.getElementById('progressText').innerText = `Soru: ${currentQ}/${d.totalQ}`;
        document.getElementById('localMistakeText').innerText = `Hata: ${localMistakes}/${d.maxErrors}`;
        
        let display = "";
        currentWordData.w.split('').forEach(l => display += localGuesses.includes(l) ? l + " " : "_ ");
        document.getElementById('wordDisplay').innerText = display;

        renderKeyboard(currentWordData.w, d);

        if(display.replace(/ /g, '') === currentWordData.w) {
            nextQuestion(d);
        }
    }

    function renderKeyboard(word, d) {
        const alf = "ABC√áDEFGƒûHIƒ∞JKLMNO√ñPRS≈ûTU√úVYZ".split('');
        const kb = document.getElementById('keyboard');
        kb.innerHTML = "";
        alf.forEach(l => {
            const btn = document.createElement('div');
            btn.className = `key ${localGuesses.includes(l) ? 'used' : ''}`;
            btn.innerText = l;
            btn.onclick = () => handleInput(l, word, d);
            kb.appendChild(btn);
        });
    }

    function handleInput(l, word, d) {
        if(localGuesses.includes(l) || isFinished) return;
        localGuesses.push(l);
        if(word.includes(l)) {
            correctSound.play();
            score += 10;
        } else {
            wrongSound.play();
            localMistakes++;
            if(localMistakes >= d.maxErrors) {
                score = Math.max(0, score - 5);
                nextQuestion(d);
            }
        }
        update(ref(db, `games/${roomID}/players/${myName}`), { score: score });
        localStorage.setItem('hangman_state', JSON.stringify({name: myName, avatar: myAvatar, currentQ, score}));
    }

    async function nextQuestion(d) {
        if(currentQ >= d.totalQ) {
            isFinished = true;
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('finalScreen').classList.add('active');
            document.getElementById('finalStats').innerHTML = `
                <p>Toplam Puan: ${score}</p>
                <p>Soru: ${currentQ}/${d.totalQ}</p>
                <p>Ba≈üarƒ±: %${Math.round((score/(d.totalQ*10))*100)}</p>
            `;
            update(ref(db, `games/${roomID}/players/${myName}`), { finished: true });
        } else {
            currentQ++;
            localGuesses = [];
            localMistakes = 0;
            // LocalStorage g√ºncelle
        }
    }

    function updateTimer(start, limit) {
        const elapsed = Math.floor((Date.now() - start) / 1000);
        const rem = limit - elapsed;
        if(rem <= 0) { isFinished = true; /* Bitir */ }
        const m = Math.floor(rem/60), s = rem%60;
        document.getElementById('timerText').innerText = `‚è± ${m}:${s<10?'0':''}${s}`;
    }

    // Mƒ∞KROFON Sƒ∞STEMƒ∞
    window.startVoice = () => {
        const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        rec.lang = 'tr-TR';
        rec.start();
        document.getElementById('micBtn').classList.add('active');
        rec.onresult = (e) => {
            const letter = e.results[0][0].transcript.toUpperCase()[0];
            const word = document.getElementById('wordDisplay').innerText.replace(/ /g, '');
            handleInput(letter, word, {maxErrors: 6}); // Basit hata kontrol√º
            document.getElementById('micBtn').classList.remove('active');
        };
    };
</script>
</body>
</html>
