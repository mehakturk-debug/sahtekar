<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Buzzer Arena Multiplayer</title>
    <style>
        :root { --red: #ff4757; --green: #2ed573; --yellow: #ffa502; --dark: #2f3542; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--dark); color: white; overflow: hidden; user-select: none; }
        
        #game-canvas { 
            width: 100%; height: 100%; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; transition: background 0.1s ease;
            cursor: pointer; position: relative;
        }

        .leaderboard {
            position: absolute; top: 10px; width: 90%; 
            display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;
            pointer-events: none;
        }
        .player-badge {
            background: rgba(0,0,0,0.4); padding: 5px 15px; border-radius: 20px;
            font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.1);
        }

        #status-text { font-size: 2.5rem; font-weight: bold; text-align: center; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #timer-display { font-size: 4rem; font-weight: 800; margin: 20px 0; font-variant-numeric: tabular-nums; }
        
        .admin-controls { position: absolute; bottom: 20px; display: flex; gap: 10px; }
        button { 
            padding: 15px 30px; border-radius: 50px; border: none; 
            background: white; color: var(--dark); font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
        }
        button:active { transform: scale(0.95); }
    </style>
</head>
<body>

<div id="game-canvas">
    <div class="leaderboard" id="leaderboard"></div>
    
    <div id="status-text">BAƒûLANILIYOR...</div>
    <div id="timer-display">0.000</div>

    <div class="admin-controls">
        <button id="start-btn">YENƒ∞ TUR BA≈ûLAT</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // --- CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyBcm1uY37IelMsTqoD0sAmsIH1nwBeYtCE",
        authDomain: "sahtekar-2f5d2.firebaseapp.com",
        databaseURL: "https://sahtekar-2f5d2-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "sahtekar-2f5d2",
        appId: "1:223883537002:web:1c16bde374d11efb5d7813"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const gameRef = ref(db, "BUZZER_SESSION_V1");

    const playerName = prompt("Adƒ±nƒ±z:") || "Oyuncu_" + Math.floor(Math.random()*100);
    
    // --- STATE ---
    let canClick = false;
    let startTime = 0;
    let isFinished = false;

    // --- DOM ---
    const canvas = document.getElementById('game-canvas');
    const statusTxt = document.getElementById('status-text');
    const timerTxt = document.getElementById('timer-display');
    const board = document.getElementById('leaderboard');
    const startBtn = document.getElementById('start-btn');

    // --- OYUN MANTIƒûI ---

    // Firebase'i Dinle
    onValue(gameRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        if (data.state === "WAITING") {
            setWaitingMode();
        } else if (data.state === "GO") {
            setGoMode();
        }
        renderLeaderboard(data.scores);
    });

    function setWaitingMode() {
        isFinished = false;
        canClick = false;
        canvas.style.backgroundColor = "var(--red)";
        statusTxt.innerText = "BEKLE...";
        timerTxt.innerText = "0.000";
    }

    function setGoMode() {
        if (isFinished) return;
        canvas.style.backgroundColor = "var(--green)";
        statusTxt.innerText = "TIKLA!";
        startTime = performance.now();
        canClick = true;
    }

    // Tƒ±klama/Dokunma Olayƒ±
    canvas.addEventListener('touchstart', handleAction);
    canvas.addEventListener('mousedown', handleAction);

    function handleAction(e) {
        if (e.target.tagName === 'BUTTON') return;
        if (isFinished) return;

        if (canClick) {
            // Ba≈üarƒ±lƒ± Tƒ±klama
            const now = performance.now();
            const score = ((now - startTime) / 1000).toFixed(3);
            isFinished = true;
            canClick = false;
            
            timerTxt.innerText = score;
            statusTxt.innerText = "TAMAMLANDI!";
            
            // Firebase'e skoru yaz
            update(ref(db, `BUZZER_SESSION_V1/scores`), {
                [playerName]: score
            });

        } else if (canvas.style.backgroundColor.includes("rgb(255, 71, 87)")) { // Kƒ±rmƒ±zƒ±ysa
            // Erken Basma
            isFinished = true;
            statusTxt.innerText = "ERKEN BASTIN!";
            timerTxt.innerText = "ELENDƒ∞";
            canvas.style.backgroundColor = "var(--yellow)";
            
            update(ref(db, `BUZZER_SESSION_V1/scores`), {
                [playerName]: "99.999" // Elenenleri en sona atar
            });
        }
    }

    // Y√∂netici: Yeni Tur Ba≈ülat
    startBtn.addEventListener('click', async () => {
        // √ñnce herkesi bekleme moduna al ve skorlarƒ± temizle
        await set(gameRef, {
            state: "WAITING",
            scores: {}
        });

        // 2-5 sn arasƒ± rastgele gecikme
        const randomDelay = Math.floor(Math.random() * 3000) + 2000;
        setTimeout(() => {
            update(gameRef, { state: "GO" });
        }, randomDelay);
    });

    function renderLeaderboard(scores) {
        if (!scores) {
            board.innerHTML = "";
            return;
        }
        const sorted = Object.entries(scores).sort((a, b) => parseFloat(a[1]) - parseFloat(b[1]));
        board.innerHTML = sorted.map(([name, score], index) => `
            <div class="player-badge">
                ${index === 0 ? 'üëë' : ''} ${name}: ${score === "99.999" ? "‚ùå" : score + "s"}
            </div>
        `).join('');
    }

</script>
</body>
</html>
