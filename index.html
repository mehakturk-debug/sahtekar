<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ä°mpostor Pro - Serbest Ses</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --red: #ef4444; --green: #22c55e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        .container { background: var(--card); border-radius: 24px; padding: 20px; width: 95%; max-width: 950px; height: 90vh; display: flex; gap: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
        .main-game { flex: 2; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; position: relative; }
        .side-panel { flex: 0.8; background: rgba(0,0,0,0.3); border-radius: 20px; padding: 15px; overflow-y: auto; border-left: 1px solid #334155; }
        .screen { display: none; width: 100%; }
        .active { display: block; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; background: #334155; border: 1px solid #475569; color: white; border-radius: 12px; }
        button { width: 100%; padding: 14px; background: var(--accent); color: #0f172a; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .player-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .player-opt { background: #334155; padding: 10px; border-radius: 12px; text-align: center; cursor: pointer; border: 2px solid transparent; }
        .player-opt.selected { border-color: var(--accent); background: #1e293b; }
        .avatar-pre { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-bottom: 5px; background: #475569; }
        .turn-box { padding: 20px; border-radius: 20px; text-align: center; margin-bottom: 20px; border: 2px solid rgba(255,255,255,0.1); }
        .word-display { background: rgba(0,0,0,0.4); padding: 20px; border-radius: 15px; font-size: 24px; text-align: center; font-weight: bold; margin: 10px 0; border-bottom: 4px solid var(--accent); }
        #micBtn { width: 100px; height: 100px; border-radius: 50%; background: var(--accent); border: none; color: #0f172a; font-size: 40px; margin: 20px auto; display: block; cursor: pointer; transition: 0.3s; outline: none; }
        #micBtn.recording { background: var(--red); box-shadow: 0 0 30px var(--red); transform: scale(1.1); }
        .side-player { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 12px; cursor: pointer; transition: 0.2s; margin-bottom: 8px; background: #334155; }
        .dm-window { position: absolute; bottom: 20px; left: 20px; width: 280px; background: #1e293b; border: 2px solid var(--accent); border-radius: 15px; padding: 15px; display: none; z-index: 100; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .dm-msgs { height: 120px; overflow-y: auto; margin-bottom: 10px; font-size: 13px; }
    </style>
</head>
<body>

<div class="container">
    <div class="main-game">
        <div id="homeScreen" class="screen active">
            <h1 style="text-align:center; color:var(--accent)">ğŸ­ Ä°mpostor HD</h1>
            <div class="player-grid">
                <div class="player-opt" data-name="Mehmet"><img src="" class="avatar-pre" id="pre-Mehmet"><span>Mehmet</span></div>
                <div class="player-opt" data-name="Emre"><img src="" class="avatar-pre" id="pre-Emre"><span>Emre</span></div>
                <div class="player-opt" data-name="Recep"><img src="" class="avatar-pre" id="pre-Recep"><span>Recep</span></div>
                <div class="player-opt" data-name="Furkan"><img src="" class="avatar-pre" id="pre-Furkan"><span>Furkan</span></div>
                <div class="player-opt" data-name="Ali"><img src="" class="avatar-pre" id="pre-Ali"><span>Ali</span></div>
            </div>
            <button onclick="document.getElementById('photoIn').click()">ğŸ“· FOTOÄRAF YÃœKLE</button>
            <input type="file" id="photoIn" accept="image/*" style="display:none">
            <input type="text" id="roomCode" placeholder="Oyun Kodu">
            <button id="btnEnter">SESÄ° AÃ‡ VE BAÄLAN</button>
        </div>

        <div id="lobbyScreen" class="screen">
            <div style="text-align:center; margin-bottom:15px; background:rgba(0,0,0,0.2); padding:10px; border-radius:15px;">Kod: <b id="displayCode"></b></div>
            <div id="modPanel" style="display:none; padding:20px; border-radius:20px; border:1px dashed var(--accent);">
                <select id="catSelect"></select>
                <button id="btnStart" style="background:var(--green)">OYUNU BAÅLAT</button>
            </div>
            <p style="text-align:center; opacity:0.6">Giren oyuncularÄ± saÄŸdan gÃ¶rebilirsin.</p>
        </div>

        <div id="gameScreen" class="screen">
            <div id="turnPanel" class="turn-box">
                <img id="activePhoto" style="width:80px; height:80px; border-radius:50%; border:3px solid var(--accent); object-fit:cover;">
                <h2 id="activePlayerName">SÄ±ra Bekleniyor...</h2>
            </div>
            <div id="wordBox" class="word-display"></div>
            <button id="micBtn">ğŸ™ï¸</button>
            <p style="text-align:center; font-size:12px; color:#94a3b8">Ä°stediÄŸin Zaman Bas KonuÅŸ</p>
            <button id="btnNext" style="display:none; background:#f59e0b">SIRADAKÄ° OYUNCU â”</button>
        </div>

        <div id="dmBox" class="dm-window">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span id="dmUser"></span><button onclick="this.parentElement.parentElement.style.display='none'">X</button></div>
            <div id="dmMsgs" class="dm-msgs"></div>
            <div style="display:flex; gap:5px;"><input type="text" id="dmIn" placeholder="Mesaj..."><button id="dmSend">></button></div>
        </div>
    </div>

    <div class="side-panel">
        <h4 style="text-align:center; color:var(--accent);">ğŸ‘¥ EKÄ°P</h4>
        <div id="sideList"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBcm1uY37IelMsTqoD0sAmsIH1nwBeYtCE",
        authDomain: "sahtekar-2f5d2.firebaseapp.com",
        databaseURL: "https://sahtekar-2f5d2-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "sahtekar-2f5d2",
        appId: "1:223883537002:web:1c16bde374d11efb5d7813"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = "", myPhoto = "", gameCode = "", mediaRec, audioChunks = [], targetDM = "";

    const cats = {
        "Meslekler": ["Doktor", "Pilot", "AÅŸÃ§Ä±", "MÃ¼hendis", "Avukat", "Ã–ÄŸretmen", "Polis", "YazÄ±lÄ±mcÄ±", "Mimar", "HemÅŸire"],
        "Hayvanlar": ["Aslan", "Fil", "ZÃ¼rafa", "Penguen", "Kaplan", "Maymun", "Yunus", "Kartal", "Kanguru", "Timsah"],
        "Yemekler": ["MantÄ±", "Ä°skender", "Lahmacun", "Pizza", "Hamburger", "DÃ¶ner", "SuÅŸi", "Makarna", "Kebap", "Pide"],
        "Åehirler": ["Ä°stanbul", "Ankara", "Ä°zmir", "Londra", "Paris", "New York", "Tokyo", "Roma", "Berlin", "Moskova"],
        "EÅŸyalar": ["Televizyon", "BuzdolabÄ±", "Ã‡amaÅŸÄ±r Makinesi", "ÃœtÃ¼", "Lamba", "Saat", "Ayna", "Koltuk", "Masa", "KitaplÄ±k"],
        "Sporlar": ["Futbol", "Basketbol", "Voleybol", "Tenis", "YÃ¼zme", "GÃ¼reÅŸ", "OkÃ§uluk", "Eskrim", "Boks", "Hentbol"],
        "Diziler": ["Kurtlar Vadisi", "Ezel", "Harry Potter", "Gora", "Ayla", "Game of Thrones", "Breaking Bad", "Sherlock", "Prison Break", "Dark"],
        "Teknoloji": ["Yapay Zeka", "Robot", "Ä°nternet", "Drone", "Blockchain", "Metaverse", "Bluetooth", "Wi-Fi", "Lazer", "Kripto"],
        "Meyve": ["Elma", "Armut", "Muz", "Ã‡ilek", "Karpuz", "Kavun", "Erik", "Kiraz", "ViÅŸne", "ÃœzÃ¼m"],
        "Hobiler": ["FotoÄŸraf", "Resim", "Gitar", "Kitap", "Kamp", "BalÄ±k Tutmak", "Dans", "Yemek", "BahÃ§e Ä°ÅŸleri", "Ã–rgÃ¼"]
    };

    window.onload = () => {
        ['Mehmet', 'Emre', 'Recep', 'Furkan', 'Ali'].forEach(n => {
            const s = localStorage.getItem('photo-'+n);
            if(s) document.getElementById('pre-'+n).src = s;
        });
        const sel = document.getElementById('catSelect');
        Object.keys(cats).forEach(k => { let o = document.createElement('option'); o.value = k; o.innerText = k; sel.appendChild(o); });
    };

    document.querySelectorAll('.player-opt').forEach(opt => {
        opt.onclick = () => {
            document.querySelectorAll('.player-opt').forEach(e => e.classList.remove('selected'));
            opt.classList.add('selected');
            myName = opt.dataset.name;
            myPhoto = localStorage.getItem('photo-'+myName) || "";
        };
    });

    document.getElementById('photoIn').onchange = (e) => {
        const r = new FileReader();
        r.onload = () => { localStorage.setItem('photo-'+myName, r.result); document.getElementById('pre-'+myName).src = r.result; myPhoto = r.result; };
        r.readAsDataURL(e.target.files[0]);
    };

    // --- SES SÄ°STEMÄ° (HERKES KONUÅABÄ°LÄ°R) ---
    async function initAudio() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true } });
        mediaRec = new MediaRecorder(stream);
        mediaRec.ondataavailable = e => audioChunks.push(e.data);
        mediaRec.onstop = () => {
            const r = new FileReader();
            r.readAsDataURL(new Blob(audioChunks));
            r.onloadend = () => update(ref(db, `games/${gameCode}/lastAudio`), { sender: myName, data: r.result, t: Date.now() });
            audioChunks = [];
        };
    }

    const mBtn = document.getElementById('micBtn');
    const startMic = async () => { if(!mediaRec) await initAudio(); if(mediaRec.state === "inactive") { mediaRec.start(); mBtn.classList.add('recording'); } };
    const stopMic = () => { if(mediaRec && mediaRec.state !== "inactive") { mediaRec.stop(); mBtn.classList.remove('recording'); } };
    mBtn.onmousedown = startMic; mBtn.onmouseup = stopMic;
    mBtn.ontouchstart = (e) => { e.preventDefault(); startMic(); }; mBtn.ontouchend = stopMic;

    // --- GAME ENGINE ---
    document.getElementById('btnEnter').onclick = async () => {
        if(!myName) return alert("Kimsin?");
        gameCode = document.getElementById('roomCode').value.trim().toUpperCase() || Math.random().toString(36).substring(2,6).toUpperCase();
        const snap = await get(ref(db, `games/${gameCode}`));
        if(!snap.exists()) await set(ref(db, `games/${gameCode}`), { status: 'waiting', moderator: myName });
        await update(ref(db, `games/${gameCode}/players/${myName}`), { name: myName, photo: myPhoto });
        
        document.getElementById('homeScreen').classList.remove('active');
        document.getElementById('lobbyScreen').classList.add('active');
        document.getElementById('displayCode').innerText = gameCode;
        listen();
    };

    function listen() {
        onValue(ref(db, `games/${gameCode}`), (s) => {
            const d = s.val(); if(!d) return;
            const players = d.players || {};
            document.getElementById('sideList').innerHTML = Object.values(players).map(p => `
                <div class="side-player" onclick="openDM('${p.name}')">
                    <img src="${p.photo}" style="width:40px; height:40px; border-radius:50%; object-fit:cover; border:2px solid var(--accent);">
                    <span style="font-size:12px; margin-left:10px;">${p.name}</span>
                </div>`).join('');

            const isMod = myName === d.moderator;
            document.getElementById('modPanel').style.display = (isMod && d.status === 'waiting') ? 'block' : 'none';

            if(d.status === 'playing') {
                document.getElementById('lobbyScreen').classList.remove('active');
                document.getElementById('gameScreen').classList.add('active');
                const active = d.playerOrder[d.turn];
                document.getElementById('activePlayerName').innerText = active;
                document.getElementById('activePhoto').src = players[active]?.photo || "";
                document.getElementById('wordBox').innerText = (d.impostor === myName) ? "ğŸ­ Ä°MPOSTORSUN" : "Kelime: " + d.word;
                document.getElementById('btnNext').style.display = isMod ? 'block' : 'none';
            }
        });

        onValue(ref(db, `games/${gameCode}/lastAudio`), (s) => {
            const a = s.val(); if(a && a.sender !== myName) new Audio(a.data).play();
        });

        onValue(ref(db, `games/${gameCode}/dms/${myName}`), (s) => {
            if(s.exists()) {
                document.getElementById('dmBox').style.display = 'block';
                const msgs = Object.values(s.val());
                document.getElementById('dmMsgs').innerHTML = msgs.map(m => `<div style="color:var(--accent); margin-bottom:5px;"><b>${m.from}:</b> ${m.txt}</div>`).join('');
                document.getElementById('dmMsgs').scrollTop = 9999;
            }
        });
    }

    window.openDM = (t) => { if(t === myName) return; targetDM = t; document.getElementById('dmBox').style.display = 'block'; document.getElementById('dmUser').innerText = t + " ile DM"; };
    document.getElementById('dmSend').onclick = () => {
        const txt = document.getElementById('dmIn').value.trim();
        if(!txt) return; push(ref(db, `games/${gameCode}/dms/${targetDM}`), { from: myName, txt: txt });
        document.getElementById('dmIn').value = "";
    };

    document.getElementById('btnStart').onclick = async () => {
        const s = await get(ref(db, `games/${gameCode}`));
        const d = s.val();
        const plist = Object.keys(d.players);
        const cat = document.getElementById('catSelect').value;
        const wordList = cats[cat];
        const word = wordList[Math.floor(Math.random() * wordList.length)];
        update(ref(db, `games/${gameCode}`), { status: 'playing', word: word, turn: 0, playerOrder: plist, impostor: plist[Math.floor(Math.random() * plist.length)] });
    };

    document.getElementById('btnNext').onclick = async () => {
        const s = await get(ref(db, `games/${gameCode}`));
        const d = s.val();
        update(ref(db, `games/${gameCode}`), { turn: (d.turn + 1) % d.playerOrder.length });
    };
</script>
</body>
</html>
