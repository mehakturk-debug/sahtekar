<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ä°mpostor Pro - Master Edition</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --red: #ef4444; --green: #22c55e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        .container { background: var(--card); border-radius: 24px; padding: 20px; width: 95%; max-width: 950px; height: 90vh; display: flex; gap: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 1px solid #334155; }
        
        /* Ana Alanlar */
        .main-game { flex: 2; display: flex; flex-direction: column; position: relative; overflow-y: auto; padding-right: 10px; }
        .side-panel { flex: 0.8; background: rgba(0,0,0,0.3); border-radius: 20px; padding: 15px; overflow-y: auto; border-left: 1px solid #334155; }
        
        .screen { display: none; width: 100%; }
        .active { display: block; }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; background: #334155; border: 1px solid #475569; color: white; border-radius: 12px; font-size: 14px; }
        button { width: 100%; padding: 14px; background: var(--accent); color: #0f172a; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        
        /* GiriÅŸ ve FotoÄŸraf */
        .player-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .player-opt { background: #334155; padding: 10px; border-radius: 12px; text-align: center; cursor: pointer; border: 2px solid transparent; }
        .player-opt.selected { border-color: var(--accent); background: #1e293b; }
        .avatar-pre { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-bottom: 5px; background: #475569; }

        /* Oyun Ä°Ã§i */
        .header-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 10px 20px; border-radius: 15px; }
        .turn-box { padding: 20px; border-radius: 20px; text-align: center; margin-bottom: 20px; border: 2px solid rgba(255,255,255,0.1); transition: 0.5s; }
        .word-display { background: rgba(0,0,0,0.4); padding: 20px; border-radius: 15px; font-size: 24px; text-align: center; font-weight: bold; margin: 10px 0; border-bottom: 4px solid var(--accent); }
        
        #micBtn { width: 100px; height: 100px; border-radius: 50%; background: #475569; border: none; color: white; font-size: 40px; margin: 20px auto; display: block; cursor: not-allowed; opacity: 0.3; transition: 0.3s; outline: none; }
        #micBtn.my-turn { cursor: pointer; opacity: 1; background: var(--accent); }
        #micBtn.recording { background: var(--red); box-shadow: 0 0 30px var(--red); transform: scale(1.1); }

        /* Yan Panel Oyuncular & DM */
        .side-player { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 12px; cursor: pointer; transition: 0.2s; margin-bottom: 8px; background: #334155; position: relative; }
        .side-player:hover { background: #475569; }
        .side-player.active-border { border: 2px solid var(--accent); }
        .side-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        
        .dm-window { position: absolute; bottom: 20px; left: 20px; width: 280px; background: #1e293b; border: 2px solid var(--accent); border-radius: 15px; padding: 15px; display: none; z-index: 100; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .dm-msgs { height: 120px; overflow-y: auto; margin-bottom: 10px; font-size: 13px; border-bottom: 1px solid #334155; }
    </style>
</head>
<body>

<div class="container">
    <div class="main-game">
        <div id="homeScreen" class="screen active">
            <h1 style="text-align:center; color:var(--accent); margin:0;">ğŸ­ Ä°mpostor Pro</h1>
            <div class="player-grid">
                <div class="player-opt" data-name="Mehmet"><img src="" class="avatar-pre" id="pre-Mehmet"><span>Mehmet</span></div>
                <div class="player-opt" data-name="Emre"><img src="" class="avatar-pre" id="pre-Emre"><span>Emre</span></div>
                <div class="player-opt" data-name="Recep"><img src="" class="avatar-pre" id="pre-Recep"><span>Recep</span></div>
                <div class="player-opt" data-name="Furkan"><img src="" class="avatar-pre" id="pre-Furkan"><span>Furkan</span></div>
                <div class="player-opt" data-name="Ali"><img src="" class="avatar-pre" id="pre-Ali"><span>Ali</span></div>
            </div>
            <button onclick="document.getElementById('photoIn').click()" style="background:#334155; font-size:12px;">ğŸ“· FOTOÄRAF YÃœKLE/DEÄÄ°ÅTÄ°R</button>
            <input type="file" id="photoIn" accept="image/*" style="display:none">
            <input type="text" id="roomCode" placeholder="Oyun Kodu (KatÄ±lmak iÃ§in)">
            <button id="btnEnter">SÄ°STEME BAÄLAN</button>
        </div>

        <div id="lobbyScreen" class="screen">
            <div class="header-info">
                <span>Oyun Kodu: <b id="displayCode" style="color:var(--accent)">-</b></span>
                <span id="playerCount">0 Oyuncu</span>
            </div>
            <div id="modPanel" style="display:none; background:rgba(255,255,255,0.05); padding:20px; border-radius:20px; border:1px dashed var(--accent);">
                <h3 style="margin-top:0; color:var(--accent)">ğŸ”§ ModeratÃ¶r AyarlarÄ±</h3>
                <label>Kategori SeÃ§:</label>
                <select id="catSelect"></select>
                <button id="btnStart" style="background:var(--green)">OYUNU BAÅLAT</button>
            </div>
            <p id="waitMsg" style="text-align:center; margin-top:30px; opacity:0.6">ModeratÃ¶r oyunu kuruyor...</p>
        </div>

        <div id="gameScreen" class="screen">
            <div class="header-info">
                <span>Kod: <b id="gameCodeDisplay" style="color:var(--accent)">-</b></span>
                <span id="roundDisplay">Tur: 1</span>
            </div>
            <div id="turnPanel" class="turn-box">
                <img id="activePhoto" style="width:80px; height:80px; border-radius:50%; border:3px solid var(--accent); object-fit:cover;">
                <h2 id="activePlayerName" style="margin:10px 0;">...</h2>
            </div>
            <div id="wordBox" class="word-display"></div>
            <button id="micBtn">ğŸ™ï¸</button>
            <p id="micHint" style="text-align:center; font-size:12px; color:#94a3b8">SÄ±ranÄ± Bekle...</p>
            <button id="btnNext" style="display:none; background:#f59e0b; margin-top:20px;">SIRADAKÄ° OYUNCU â”</button>
        </div>

        <div id="dmBox" class="dm-window">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span id="dmUser" style="font-weight:bold; color:var(--accent); font-size:12px;"></span>
                <button onclick="document.getElementById('dmBox').style.display='none'" style="width:20px; height:20px; padding:0; margin:0; line-height:1;">X</button>
            </div>
            <div id="dmMsgs" class="dm-msgs"></div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="dmIn" placeholder="Mesaj..." style="margin:0; padding:5px; font-size:12px;">
                <button id="dmSend" style="width:50px; padding:0; margin:0; font-size:11px;">GÃ–NDER</button>
            </div>
        </div>
    </div>

    <div class="side-panel">
        <h4 style="text-align:center; margin-top:0; color:var(--accent); border-bottom:1px solid #334155; padding-bottom:10px;">ğŸ‘¥ EKÄ°P</h4>
        <div id="sideList"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBcm1uY37IelMsTqoD0sAmsIH1nwBeYtCE",
        authDomain: "sahtekar-2f5d2.firebaseapp.com",
        databaseURL: "https://sahtekar-2f5d2-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "sahtekar-2f5d2",
        appId: "1:223883537002:web:1c16bde374d11efb5d7813"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = "", myPhoto = "", gameCode = "", mediaRec, audioChunks = [], targetDM = "";

    const cats = {
        "Meslekler": ["Doktor", "Pilot", "AÅŸÃ§Ä±", "MÃ¼hendis", "Avukat", "Ã–ÄŸretmen", "Polis", "YazÄ±lÄ±mcÄ±", "Mimar", "HemÅŸire"],
        "Hayvanlar": ["Aslan", "Fil", "ZÃ¼rafa", "Penguen", "Kaplan", "Maymun", "Yunus", "Kartal", "Kanguru", "Timsah"],
        "Yemekler": ["MantÄ±", "Ä°skender", "Lahmacun", "Pizza", "Hamburger", "Kuru Fasulye", "Kebap", "DÃ¶ner", "SuÅŸi", "Makarna"],
        "Åehirler": ["Ä°stanbul", "Ankara", "Ä°zmir", "Londra", "Paris", "New York", "Tokyo", "Roma", "Berlin", "Moskova"],
        "EÅŸyalar": ["Televizyon", "BuzdolabÄ±", "Ã‡amaÅŸÄ±r Makinesi", "ÃœtÃ¼", "Lamba", "Saat", "Ayna", "Koltuk", "Masa", "KitaplÄ±k"],
        "Sporlar": ["Futbol", "Basketbol", "Voleybol", "Tenis", "YÃ¼zme", "GÃ¼reÅŸ", "OkÃ§uluk", "Eskrim", "Boks", "Hentbol"],
        "Diziler": ["Kurtlar Vadisi", "Ezel", "Avrupa YakasÄ±", "Harry Potter", "Star Wars", "Gora", "Ayla", "Game of Thrones", "Breaking Bad", "Sherlock"],
        "Teknoloji": ["Yapay Zeka", "Robot", "Ä°nternet", "Drone", "Blockchain", "Metaverse", "Bluetooth", "Wi-Fi", "Lazer", "Kripto"],
        "Meyve": ["Elma", "Armut", "Muz", "Ã‡ilek", "Karpuz", "Kavun", "Erik", "Kiraz", "ViÅŸne", "ÃœzÃ¼m"],
        "Hobiler": ["FotoÄŸraf", "Resim", "Gitar", "Kitap", "Kamp", "BalÄ±k Tutmak", "Dans", "Yemek", "BahÃ§e Ä°ÅŸleri", "Ã–rgÃ¼"]
    };

    window.onload = () => {
        ['Mehmet', 'Emre', 'Recep', 'Furkan', 'Ali'].forEach(n => {
            const s = localStorage.getItem('photo-'+n);
            if(s) document.getElementById('pre-'+n).src = s;
        });
        const sel = document.getElementById('catSelect');
        Object.keys(cats).forEach(k => { let o = document.createElement('option'); o.value = k; o.innerText = k; sel.appendChild(o); });
    };

    document.querySelectorAll('.player-opt').forEach(opt => {
        opt.onclick = () => {
            document.querySelectorAll('.player-opt').forEach(e => e.classList.remove('selected'));
            opt.classList.add('selected');
            myName = opt.dataset.name;
            myPhoto = localStorage.getItem('photo-'+myName) || "";
        };
    });

    document.getElementById('photoIn').onchange = (e) => {
        if(!myName) return alert("Ã–nce ismini seÃ§!");
        const r = new FileReader();
        r.onload = () => { localStorage.setItem('photo-'+myName, r.result); document.getElementById('pre-'+myName).src = r.result; myPhoto = r.result; };
        r.readAsDataURL(e.target.files[0]);
    };

    // HQ SES SÄ°STEMÄ°
    async function initAudio() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true } });
        mediaRec = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
        mediaRec.ondataavailable = e => audioChunks.push(e.data);
        mediaRec.onstop = () => {
            const r = new FileReader();
            r.readAsDataURL(new Blob(audioChunks));
            r.onloadend = () => update(ref(db, `games/${gameCode}/lastAudio`), { sender: myName, data: r.result, time: Date.now() });
            audioChunks = [];
        };
    }

    const mBtn = document.getElementById('micBtn');
    const toggleRec = (start) => {
        if(!mBtn.classList.contains('my-turn')) return;
        if(start) { if(!mediaRec) initAudio().then(() => mediaRec.start()); else mediaRec.start(); mBtn.classList.add('recording'); }
        else { if(mediaRec && mediaRec.state !== "inactive") mediaRec.stop(); mBtn.classList.remove('recording'); }
    };
    mBtn.onmousedown = () => toggleRec(true); mBtn.onmouseup = () => toggleRec(false);
    mBtn.ontouchstart = (e) => { e.preventDefault(); toggleRec(true); }; mBtn.ontouchend = () => toggleRec(false);

    // GAME ENGINE
    document.getElementById('btnEnter').onclick = async () => {
        if(!myName) return alert("Kim olduÄŸunu seÃ§!");
        gameCode = document.getElementById('roomCode').value.trim().toUpperCase() || Math.random().toString(36).substring(2,6).toUpperCase();
        const snap = await get(ref(db, `games/${gameCode}`));
        if(!snap.exists()) await set(ref(db, `games/${gameCode}`), { status: 'waiting', moderator: myName });
        await update(ref(db, `games/${gameCode}/players/${myName}`), { name: myName, photo: myPhoto });
        
        showScreen('lobbyScreen');
        document.getElementById('displayCode').innerText = gameCode;
        document.getElementById('gameCodeDisplay').innerText = gameCode;
        listen();
    };

    function listen() {
        onValue(ref(db, `games/${gameCode}`), (s) => {
            const d = s.val(); if(!d) return;
            const players = d.players || {};
            const pCount = Object.keys(players).length;
            document.getElementById('playerCount').innerText = pCount + " Oyuncu";

            // Yan Panel
            const list = document.getElementById('sideList');
            list.innerHTML = Object.values(players).map(p => `
                <div class="side-player ${p.name === d.playerOrder?.[d.turn] ? 'active-border' : ''}" onclick="openDM('${p.name}')">
                    <img src="${p.photo}" class="side-avatar">
                    <span style="font-size:12px;">${p.name} ${p.name === d.moderator ? 'ğŸ‘‘' : ''}</span>
                </div>
            `).join('');

            const isMod = myName === d.moderator;
            document.getElementById('modPanel').style.display = (isMod && d.status === 'waiting') ? 'block' : 'none';
            document.getElementById('waitMsg').style.display = (!isMod && d.status === 'waiting') ? 'block' : 'none';

            if(d.status === 'playing') {
                showScreen('gameScreen');
                const active = d.playerOrder[d.turn];
                document.getElementById('activePlayerName').innerText = active;
                document.getElementById('activePhoto').src = players[active]?.photo || "";
                document.getElementById('wordBox').innerText = (d.impostor === myName) ? "ğŸ­ Ä°MPOSTORSUN" : "Kelime: " + d.word;
                document.getElementById('turnPanel').style.borderColor = players[active]?.name === myName ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
                
                if(active === myName) { mBtn.classList.add('my-turn'); document.getElementById('micHint').innerText = "KONUÅABÄ°LÄ°RSÄ°N (BasÄ±lÄ± Tut)"; }
                else { mBtn.classList.remove('my-turn'); document.getElementById('micHint').innerText = "SÄ±ra " + active + " kullanÄ±cÄ±sÄ±nda."; }
                document.getElementById('btnNext').style.display = isMod ? 'block' : 'none';
            }
        });

        onValue(ref(db, `games/${gameCode}/lastAudio`), (s) => {
            const a = s.val(); if(a && a.sender !== myName) new Audio(a.data).play();
        });

        onValue(ref(db, `games/${gameCode}/dms/${myName}`), (s) => {
            if(s.exists()) {
                document.getElementById('dmBox').style.display = 'block';
                const msgs = Object.values(s.val());
                document.getElementById('dmMsgs').innerHTML = msgs.map(m => `<div style="color:var(--accent); margin-bottom:5px;"><b>${m.from}:</b> ${m.txt}</div>`).join('');
                document.getElementById('dmMsgs').scrollTop = 9999;
            }
        });
    }

    window.openDM = (t) => { if(t === myName) return; targetDM = t; document.getElementById('dmBox').style.display = 'block'; document.getElementById('dmUser').innerText = t + " ile DM"; };
    document.getElementById('dmSend').onclick = () => {
        const txt = document.getElementById('dmIn').value.trim();
        if(!txt) return; push(ref(db, `games/${gameCode}/dms/${targetDM}`), { from: myName, txt: txt });
        document.getElementById('dmIn').value = "";
    };

    document.getElementById('btnStart').onclick = async () => {
        const s = await get(ref(db, `games/${gameCode}`));
        const d = s.val();
        const plist = Object.keys(d.players);
        const cat = document.getElementById('catSelect').value;
        const word = cats[cat][Math.floor(Math.random() * 10)];
        update(ref(db, `games/${gameCode}`), { status: 'playing', word: word, turn: 0, playerOrder: plist, impostor: plist[Math.floor(Math.random() * plist.length)] });
    };

    document.getElementById('btnNext').onclick = async () => {
        const s = await get(ref(db, `games/${gameCode}`));
        const d = s.val();
        update(ref(db, `games/${gameCode}`), { turn: (d.turn + 1) % d.playerOrder.length });
    };

    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
</script>
</body>
</html>
